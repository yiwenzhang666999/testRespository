define(["treeHelper","severZtree","config","bhdk","report"],function(b,q,z,y,t){var w;var d;var i;var p={expandLevel:1,sort:{BHDK:[{jb:2,rule:function(B,A){if(A.length>1){A.sort(function(D,C){if(!D.sort){return -1}if(!C.sort){return 1}return(D.sort.localeCompare(C.sort))})}return A}},{jb:3,rule:function(B,A){if(A.length>1){A.sort(function(D,C){if(!D.sort){return -1}if(!C.sort){return 1}return(D.sort.localeCompare(C.sort))})}return A}},{jb:4,rule:function(B,A){if(A.length>1){A.sort(function(D,C){if(!D.sort){return -1}if(!C.sort){return 1}return(D.sort.localeCompare(C.sort))})}}}]}};var l=b.getTree("zyjg",p,[]);function v(){var B=-1;if(userObj&&userObj.userId){B=userObj.userId}var A=b;f()}function f(){var A={userid:userObj.userId,appid:window.appid_};$.ajax({url:"./tree/initialTree.do",type:"POST",async:false,data:{data:JSON.stringify({where:A})},success:function(C){var D=C.replace(/"data"/g,'"_data"');var E=JSON.parse(D);var B=b.getTree("zyjg");B.addNodes(E[0]);B.addNodes(E[1]);$("[tid='bhdk'] a:first .ck-box").click()},error:function(B){}})}function x(A,B){if(A==null||A==""||typeof(A)=="undefined"||typeof(A)==undefined){return}w=A.toString();if(w.length==6&&!w.startsWith("2000")){j(w)}else{$.ajax({type:"GET",url:z.publicService+"/ws/rest/LS/search/"+A,dataType:"JSON",success:function(I){if(B){u(w);$("#bhdk_area_zq").remove();$("#zq_contexts").remove()}if(I!=null){var C=I.item.code;var D=I.item.level;var E=$('<p  style="cursor:pointer;font-size:12px;"  class="title" zqcode="'+C+'" id="bhdk_area_zq">'+I.item.name+":</p>");E.on("click",function(){x(C,true)});$("#centent").append(E);var G=$('<p class="context" id="zq_contexts"> </p>');$("#centent").append(G);var M="";M="";if(I.child){var K=I.child;if(w.length==4){o(w,K);i=I.item.name}else{if(w.length==2){d=I.item.name}for(var J=0;J<K.length;J++){var H=K[J].code;var F=K[J].level;var L=$("<a  style='cursor:pointer;font-size:12px;' >"+K[J].name+"</a>");(function(O,N){L.on("click",function(){x(O,true)})})(H,F);$("#zq_contexts").append(L)}}}}},error:function(){}})}}function j(A){$("#centent")[0].innerHTML="";var B=r(A);var C=$('<a  style="cursor: pointer; font-size: 12px; color: rgb(153, 153, 153); padding:1px 5px;"  class="title" zqcode="'+A+'"  id="bhdk_area_zq">'+B+"</a>");C.on("click",function(){d=r(A.substring(0,2));i=r(A.substring(0,4));var G;if($(this).hasClass("xianSelected")){$(this).removeClass("xianSelected");G=n(A);e(G)}else{y.addNewBhdk(this.innerText,A,$("#bhdkYears").val(),d,i);G=n(A);if(G){$(this).addClass("xianSelected");this.style.color="#999"}}m()});$("#centent").append(C);if($("#bhdkYears").val()){var E={callback:function(G){if(G.length>0){$("#bhdk_area_zq").addClass("xianSelected")}},exceptionHandler:function(G){}};var F={selectFields:"C_XIAN,C_XIANNAME",whereString:"C_XIAN = '"+w+"' AND C_WORKYEAR = '"+$("#bhdkYears").val()+"' AND I_USERID = "+userObj.userId+" AND C_APPID = '"+window.appid_+"'"};FsService.getEntityList("FS_BUSINESS_USERBUSLAYERS",F,E)}else{var D=n(w);if(D){$("#bhdk_area_zq").addClass("xianSelected")}}}function m(){var A=c();var J=h();var K;$("#loadedBhdkq").remove();if(A.length>0){$("#loadedBhdk h2").show();var B=$("<div id=loadedBhdkq></div>");$("#loadedBhdk").append(B);var G=J[0].sort();var F=J[1];var L=J[2];for(var H=0;H<G.length;H++){var D=L[G[H]];K=D.text;var C=$("<div><span sheng='"+G[H]+"'><i></i>"+K+":</span><p class="+K+"></p></div>");$("#loadedBhdkq").append(C);for(var I=0;I<F.length;I++){if(F[I].xian.startsWith(G[H])){var E=$("<a xiancode ='"+F[I].xian+"'><i></i>"+F[I].text+"</a>");E.on("click",function(){var M=n(this.getAttribute("xiancode"));e(M);this.remove();g(this.innerText);m()});$("."+K).append(E)}}}k()}else{$("#loadedBhdk h2").hide()}}function h(){var B=c();var G=[];var E=[];var F=[];var A={};for(var D=0;D<B.length;D++){if(B[D].jb==2){E.push(B[D].sort);A[B[D].sort]=B[D];if(B[D].children.length>0){for(var C=0;C<B[D].children.length;C++){F.push(B[D].children[C])}}}}G.push(E);G.push(F);G.push(A);return G}function c(){var A=b.getTree("zyjg");var B=A.getNodes()[0].children;return B}function k(){$("#loadedBhdkq div span").click(function(E){var D;var B=$(this).parent().find("a");this.remove();var A=b.getTree("zyjg");var C={sheng:this.getAttribute("sheng"),userid:userObj.userId,appid:window.appid_};$.ajax({url:"bhdk/delProvincedatas.do",type:"POST",async:false,data:{data:JSON.stringify({where:C})},success:function(F){for(var G=0;G<B.length;G++){B[G].remove();g($(B[G])[0].innerText);D=n(B[G].getAttribute("xiancode"));A.removeNodeById(D.id);t.createZqList();for(var H=0;H<A.__data.length;H++){if(D.id.indexOf(A.__data[H].id)>-1){y.getChildrenNode(A.__data[H],D.pid)}}}m()},error:function(F){}})})}function g(A){if(userObj.zqCode.length==6&&!userObj.zqCode.startsWith("2000")){$("#bhdk_area_zq").removeClass("xianSelected")}var C=$("#zq_contexts a");for(var B=0;B<C.length;B++){if(A==C[B].innerText){$(C[B]).removeClass("xianSelected")}}}function a(){$.ajax({url:"bhdk/getYear.do",type:"post",dataType:"JSON",async:false,success:function(B){if(typeof B=="number"){for(var A=(B-1);A<(B+5);A++){$("#bhdkYears").append("<option>"+A+"</option>")}$("#bhdkYears").change(function(){x(w,true)})}else{}},error:function(){}})}function u(E){var H=$("#clickHistorys w").length;if(H==0){var D=$("#bhdk_area_zq");var G=D.attr("zqcode");var F=$("#bhdk_area_zq")[0].innerText;var B=F.split(":");var A=B[0];var C=$('<w  style="cursor:pointer;font-size:12px;color:#3d9b00"  class="title position" level="1" zqcode="'+G+'"id="'+G+'_zqcode">'+A+"&nbsp;&nbsp;</w>");C.on("click",function(){x(G,true)});$("#clickHistorys").append(C)}else{s(H,E)}}function s(G,C){var D=$("#"+C+"_zqcode");if(D.length>0){D.nextAll().remove();$("#"+C+"_zqcode").remove();var E=$("#clickHistorys w").length}else{var J=$("#bhdk_area_zq");var B=J.attr("zqcode");if(document.getElementById(B+"_zqcode")){$("#"+B+"_zqcode").remove()}var I=$("#bhdk_area_zq")[0].innerText;var F=I.split(":");var H=F[0];var A=$('<w  style="cursor:pointer;font-size:12px;color: #3d9b00;"  class="title" level="'+(G+1)+'" zqcode="'+B+'"id="'+B+'_zqcode"><span class="arr" style="display: inline-block;margin: 0px 5px 5px 0;font-size: 12px;color: #3d9b00;">&gt;</span>'+H+"&nbsp;&nbsp;</w>");A.on("click",function(){x(B,true)});$("#clickHistorys").append(A)}}function o(A,B){var E;var C={callback:function(H){var J;for(var G=0;G<B.length;G++){if(H&&H.length>0){for(var F=0;F<H.length;F++){J=H[F].originalObjects.C_XIAN;if(J==B[G].code){E=$("<a  style='cursor:pointer;font-size:12px;' class ='xianSelected'>"+B[G].name+"</a>");break}else{E=$("<a  style='cursor:pointer;font-size:12px;' >"+B[G].name+"</a>")}}}else{E=$("<a  style='cursor:pointer;font-size:12px;' >"+B[G].name+"</a>")}var I=B[G].code;var K=B[G].level;(function(M,L){E.on("click",function(){var N;if(this.className=="xianSelected"){$(this).removeClass("xianSelected");N=n(M);e(N)}else{d=r(w.substring(0,2));y.addNewBhdk(this.innerText,M,$("#bhdkYears").val(),d,i);N=n(M);if(N){$(this).addClass("xianSelected")}}m()})})(I,K);$("#zq_contexts").append(E)}},exceptionHandler:function(F){}};var D={selectFields:"C_XIAN,C_XIANNAME",whereString:"C_XIAN  LIKE '"+A+"%' AND C_WORKYEAR = '"+$("#bhdkYears").val()+"' AND I_USERID = "+userObj.userId+" AND C_APPID = '"+window.appid_+"'"};FsService.getEntityList("FS_BUSINESS_USERBUSLAYERS",D,C)}function n(F){var E="";var A=b.getTree("zyjg");var B=A.getNodes()[0].children;for(var D=0;D<B.length;D++){if(B[D].children.length>0){for(var C=0;C<B[D].children.length;C++){if(F==B[D].children[C].xian){E=B[D].children[C];break}}}}return E}function e(C){var D="";if(C){for(var B=0;B<C.children.length;B++){D+=C.children[B]["_data"]["nd"]+"','"}D=D.substring(0,D.length-3);var A={id:C.pid.replace("bhdk",""),xian:C._data["xian"],nd:D,userid:userObj.userId,appid:window.appid_};y.del(A,C.id,C.pid)}}function r(B){var A="";$.ajax({type:"GET",url:z.publicService+"/ws/rest/LS/search/"+B,dataType:"JSON",async:false,success:function(C){if(C!=null){A=C.item.name}},error:function(C){}});return A}return{init:v,getYear:a,loadUserLayerManagePanel:x,loadTreeHasAdded:m}});
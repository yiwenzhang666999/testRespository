define(["treeHelper","config","report","util"],function(f,u,o,a){var s=[];var k=null;var n=$("#zyjg_bhdk");var c="-1";function g(){if(userObj&&userObj.userId){c=userObj.userId}var v=f.getTree("zyjg");var w=0;v.bindEvent(f.eventTarget.BHDK,f.events.MORE_CLICK,function(x){$(".more",$("[tid="+x.id+"]")).modal({title:"变化地块图层管理",overlay:false,showMin:false,showMax:false,showTop:false,isDrag:true,contentWidth:"auto",fullScreenId:"map_continer",type:"ajax",target:"./ibox/zyjg/bhdk/_tjdkbhsj.html"});if(w++!=0){return}else{$(".more",$("[tid="+x.id+"]")).click()}});v.bindEvent(f.eventTarget.BHDK,f.events.DEL_CLICK,function(z){if(z.children){var A="";for(var y=0;y<z.children.length;y++){A+=z.children[y]["_data"]["nd"]+"','"}A=A.substring(0,A.length-3);var x={id:z.pid.replace("bhdk",""),xian:z._data["xian"],nd:A,userid:c,appid:window.appid_};i(x,z.id,z.pid)}})}function e(){$("#xianName").val("");document.getElementById("bhdk_item").innerHTML=""}function b(){$("input[name='add']").unbind("click").on("click",l);$("input[name='create']").unbind("click").on("click",l)}function j(){var v=$("#xianName").val();var w="background: rgb(238, 238, 238); color: rgb(136, 136, 136); border: 1px solid rgb(170, 170, 170);";$.ajax({type:"GET",url:u.publicService+"/ws/rest/LS/analyze/"+v,dataType:"JSON",async:false,success:function(B){document.getElementById("bhdk_item").innerHTML="";s=[];if(B.length>0){for(var A=0;A<3;A++){var C="";C+="<p class='line'><span class='name'>"+B[A].fullName+"</span>";C+="<span class='opa'><input type='button' id='yl"+A+"' class='zs-btn reset' value='预览' disabled='disabled' style='"+w+"'/>";var z={xian:B[A].location.code,appid:window.appid_,tableid:"1",nd:$("#bhdkNd").val()};var y=r(JSON.stringify(z));z.userid=c;z.tableid="2";var x=r(z);if(y&&!x){C+="<input type='button' id='add"+A+"' name='add' data='"+A+"' class='zs-btn reset' value='添加' />";$("#bhdk_item").append(C)}if(y&&x){C+="<input type='button' id='create"+A+"' name='create' data='"+A+"' class='zs-btn reset' value='添加'/></span></p>";$("#bhdk_item").append(C);$("#create"+A).attr("disabled","disabled");$("#create"+A)[0].style.cssText=w}if(!y){C+="<input type='button' id='create"+A+"' name='create' data='"+A+"' class='zs-btn reset' value='添加'/></span></p>";$("#bhdk_item").append(C)}}s=B;b()}},error:function(x){console.log(x)}})}function m(y,D,z,E,B){var x=D;var A={xian:x,appid:window.appid_,tableid:"1",nd:z};var C=r(JSON.stringify(A));A.userid=c;A.tableid="2";var v=r(A);var w="";if(C&&!v){w="bhdk/add.do"}if(C&&v){mini.alert("当前变化图斑已存在！","温馨提示");closeAlert()}if(!C){w="bhdk/create.do"}if(w!=""){q(y,D,E,B,w,z)}}function r(w){var v=false;$.ajax({url:"bhdk/getData.do",type:"POST",async:false,data:{data:JSON.stringify({where:w})},success:function(x){if(x=="true"){v=true}},error:function(x){a.validateSession(err)}});return v}function q(x,E,G,B,v,z){if(!v){var C=$(this);var v="";if(C.attr("id").indexOf("add")>-1){v="bhdk/add.do"}else{if(C.attr("id").indexOf("create")>-1){v="bhdk/create.do"}}C.removeClass();C.addClass("zs-btn");data=s[C.attr("data")]}var w=E.substring(0,2);var F=E;var A=x;var y=G+B+x;if(!z){z=$("#bhdkNd").val()}k=F;var D={sheng:w,shengName:G,xian:F,Xname:A,fullName:y,nd:z,userid:c,appid:window.appid_};$.ajax({url:v,type:"POST",async:false,data:{data:JSON.stringify(D)},success:function(I){if(I){$("#xianName").trigger("keypress");var H=f.getTree("zyjg");var J=JSON.parse(I);H.addNodes(J);$("[tid='"+J.id+"'] i:first").click();if($(".tool-tj").hasClass("selected")){o.createZqList()}}closeAlert()},error:function(H){mini.alert("添加失败！","失败提示");closeAlert();a.validateSession(err)}})}function d(x,y){if(x.id==y&&(!x.children||x.children.length==0)){var v=f.getTree("zyjg");v.removeNodeById(x.id)}else{if(x.children){for(var w=0;w<x.children.length;w++){d(x.children[w],y)}}}}function i(w,x,v){$.ajax({url:"bhdk/delTdata.do",type:"POST",async:false,data:{data:JSON.stringify({where:w})},success:function(z){var y=f.getTree("zyjg");y.removeNodeById(x);if($(".tool-tj").hasClass("selected")){o.createZqList()}for(var A=0;A<y.__data.length;A++){if(x.indexOf(y.__data[A].id)>-1){d(y.__data[A],v)}}},error:function(y){a.validateSession(err)}})}function h(w){var v="";$.ajax({type:"GET",url:u.publicService+"/ws/rest/LS/search/"+w,dataType:"JSON",async:false,success:function(x){if(x!=null){v=x.item.name}},error:function(x){a.validateSession(err)}});return v}function t(w,x){var v=[];$.ajax({url:"bhdk/getTData.do",type:"POST",async:false,data:{data:JSON.stringify({where:x,tableName:w})},success:function(y){v=y},error:function(y){a.validateSession(err)}});return v}function p(v,y,x){var w="background: rgb(238, 238, 238); color: rgb(136, 136, 136); border: 1px solid rgb(170, 170, 170);";$.ajax({type:"GET",url:u.publicService+"/ws/rest/LS/analyze/"+v,dataType:"JSON",async:false,success:function(G){openAlert();if(G.length>0){var F=true;for(var D=0;D<G.length;D++){var E=G[D].location.code;if(y==E){F=false;var C={xian:G[D].location.code,appid:window.appid_,tableid:"1",nd:x};var A=r(JSON.stringify(C));C.userid=c;C.tableid="2";var z=r(C);var B="";if(A&&!z){B="bhdk/add.do"}if(A&&z){mini.alert("当前变化图斑已存在！","温馨提示");closeAlert()}if(!A){B="bhdk/create.do"}if(B!=""){l(G[D],B,x)}}}if(F){mini.alert("添加失败！","失败提示");closeAlert()}}else{mini.alert("添加失败！","失败提示");closeAlert()}},error:function(z){mini.alert("添加失败！","失败提示");closeAlert();a.validateSession(err)}})}function l(z,v,y){if(!v){var B=$(this);var v="";if(B.attr("id").indexOf("add")>-1){v="bhdk/add.do"}else{if(B.attr("id").indexOf("create")>-1){v="bhdk/create.do"}}B.removeClass();B.addClass("zs-btn");z=s[B.attr("data")]}if(z){var w=z.location.code.substring(0,2);var E=z.location.code;var A=z.location.name;var x=z.fullName;if(!y){y=$("#bhdkNd").val()}var D=h(w);k=E;var C={sheng:w,shengName:D,xian:E,Xname:A,fullName:x,nd:y,userid:c,appid:window.appid_};$.ajax({url:v,type:"POST",async:false,data:{data:JSON.stringify(C)},success:function(G){if(G){$("#xianName").trigger("keypress");var F=f.getTree("zyjg");var H=JSON.parse(G);F.addNodes(H);$("[tid='"+H.id+"'] i:first").click();if($(".tool-tj").hasClass("selected")){o.createZqList()}}closeAlert()},error:function(F){mini.alert("添加失败！","失败提示");closeAlert();a.validateSession(err)}})}}return{init:g,search:j,del:i,addBhdk:p,addNewBhdk:m,getChildrenNode:d,}});
define(["publicObj","queryLayer","util","treeHelper","config"],function(y,aa,ad,B,T){var g=0;var k=0;var ak=[];var aA={};var l={};var S=0;var H=0;var P=0;var f=0;var G=0.0001;var E=0;var D=0;var A=[];var U={};var c=[];var O=[];var ai={};var x=0;var ah=null;var N=null;var Q=null;var ao=null;var Z=null;var aB=null;var m={"0":"未审核","1":"通过","2":"通过（已修改）","3":"重做","-1":"没变化"};var ap=new ol.format.GeoJSON();var I=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0)"}),stroke:new ol.style.Stroke({color:"#FF0000",width:2}),});var u=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0)"}),stroke:new ol.style.Stroke({color:"#FFFF00",width:2}),});var t=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0.5)"}),stroke:new ol.style.Stroke({color:"#00FF00",width:2}),});var n="images/gezi-bg.png";var M="images/gezi-wbg.png";function V(){ah=map.getLayerByName("SHDK_YWC_LAYER").getSource();ao=map.getLayerByName("SHDK_WWC_LAYER").getSource();Z=map.getLayerByName("SHDK_HIGH_LAYER").getSource();aB=map.getLayerByName("HIGH_LAYER").getSource();N=map.getLayerByName("SHDK_P_YWC_LAYER").getSource();Q=map.getLayerByName("SHDK_P_WWC_LAYER").getSource();map.getLayerByName("SHDK_P_YWC_LAYER").setVisible(false);map.getLayerByName("SHDK_P_WWC_LAYER").setVisible(false);$(".zs-toolbar .btns a.tool-sh").click(function(aC){if($(this).hasClass("selected")){$("#shdk_pop .close-btn").click();$(this).removeClass("selected")}else{q();$(this).addClass("selected")}});$(".tool-wg").click(function(aC){if($(".zs-grid-tool").is(":visible")){$(".zs-grid-tool").hide();$(this).removeClass("selected");b();if($("#public_shdk_pop.plugin-with-box").length==1){}}else{$(".zs-grid-tool").show();$(this).addClass("selected");an()}});$("#createGrid").click(function(aC){if(!$("#shdkSelect").val()){mini.alert("请选择县！");return}mini.confirm("是否创建判图格网？","提示",function(aD){if(aD=="ok"){$(".close.iconfont.icon-zsicon-close").trigger("click");au()}})});$("#viewGrid").click(function(aC){au(true)});$("#closeviewGrid").click(function(aC){al()});$("#autoGrid").click(function(aD){var aC=o();$("#grid_width").val(aC[0]);$("#grid_height").val(aC[1])});$(".zs-grid-tool .line.wcqk input").click(function(aC){w();at()});$(".zs-grid-tool .line.dhfw input").click(function(aC){ae()});$("#shtbSelect").change(function(aC){p(aC)});$("#shdkSelect").change(function(aC){al()});$(".zs-btn.syg-button").click(function(aC){l={};W(true)});$(".zs-btn.xyg-button").click(function(aC){l={};W(false)});$(".zs-btn.syg-grid-button").click(function(aC){az(true)});$(".zs-btn.shwg-grid-button").click(function(aE){var aC=Z.idIndex_;for(var aD in aC){if(typeof aD=="string"){av(aD);break}}});$(".zs-btn.xyg-grid-button").click(function(aC){az(false)});$(".zs-btn.qt-grid-button").click(function(aC){ac(true)});$(".zs-btn.fd-grid-button").click(function(aC){ac(false)});$(".zs-grid-tool #reload").click(function(aC){ae()});$("#shdk_grid_current").keydown(function(aC){if(aC.keyCode==13){R()}});$("#shdk_current").keydown(function(aC){if(aC.keyCode==13){L()}});map.getMap().on("moveend",function(aD){w();var aC=map.getMap().getView().getZoom();if(aC>15){aq(true)}else{aq(false)}})}function q(){var aC={ID:1,C_TYPE:"default",C_ZQCODE:"200000",I_USERID:1,C_NR:[{FIELDNAME:"C_XIAN",DICTNAME:"县(林业局)",FIELDTYPE:"STRING",ZINDEX:1,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_XIANG",DICTNAME:"乡(林场)",FIELDTYPE:"STRING",ZINDEX:2,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_CUN",DICTNAME:"村(林班)",FIELDTYPE:"STRING",ZINDEX:3,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_XIAOBAN",DICTNAME:"小班",FIELDTYPE:"STRING",ZINDEX:5,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_WORKYEAR",DICTNAME:"工作年度",FIELDTYPE:"STRING",ZINDEX:6,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"I_LON_DEG",DICTNAME:"经度",FIELDTYPE:"DOUBLE",ZINDEX:7,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"I_LAT_DEG",DICTNAME:"纬度",FIELDTYPE:"DOUBLE",ZINDEX:8,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"D_AREA",DICTNAME:"面积",FIELDTYPE:"STRING",ZINDEX:9,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_YSBHYY",DICTNAME:"疑似变化原因",FIELDTYPE:"STRING",ZINDEX:10,CANSHOW:"是",DICTITEM:[{CODE:1,NAME:"采伐"},{CODE:2,NAME:"占地"},{CODE:3,NAME:"毁林开垦"},{CODE:4,NAME:"灾害"},{CODE:5,NAME:"造林"},{CODE:6,NAME:"其他减少"},{CODE:7,NAME:"其他增加"}]},{FIELDNAME:"C_HSBHYY",DICTNAME:"核实变化原因",FIELDTYPE:"STRING",ZINDEX:11,CANSHOW:"是",DICTITEM:[{CODE:10,NAME:"造林更新"},{CODE:20,NAME:"森林采伐"},{CODE:30,NAME:"规划调整"},{CODE:41,NAME:"经审批使用林地"},{CODE:42,NAME:"未审批使用林地"},{CODE:50,NAME:"毁林开垦"},{CODE:71,NAME:"火灾"},{CODE:72,NAME:"地质灾害"},{CODE:73,NAME:"其它灾害因素"},{CODE:81,NAME:"封山育林"},{CODE:82,NAME:"其他自然更新"},{CODE:91,NAME:"漏划"},{CODE:92,NAME:"错划"},{CODE:93,NAME:"其它调查因素"},{CODE:96,NAME:"行政界线调整"},{CODE:99,NAME:"管理因子变化"},{CODE:11,NAME:"人工造林或飞播造林"},{CODE:12,NAME:"人工更新"},{CODE:98,NAME:"新增管理界线"},{CODE:97,NAME:"边界引起的细碎合并"},]},{FIELDNAME:"C_YIJU",DICTNAME:"依据",FIELDTYPE:"STRING",ZINDEX:12,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_USERNAME",DICTNAME:"判读人",FIELDTYPE:"STRING",ZINDEX:13,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"DT_CREATETIME",DICTNAME:"判读时间",FIELDTYPE:"DATA",ZINDEX:14,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_CHECKUSERNAME",DICTNAME:"审核人",FIELDTYPE:"STRING",ZINDEX:15,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"DT_CHECKTIME",DICTNAME:"审核时间",FIELDTYPE:"DATA",ZINDEX:16,CANSHOW:"是",DICTITEM:""},{FIELDNAME:"C_STATUS_DESC",DICTNAME:"审核状态",FIELDTYPE:"DATA",ZINDEX:17,CANSHOW:"是",DICTITEM:""},]};Y(null,y.features[0],aC)}function Y(aF,aD,aE){var aC=af(aE);var aG=$("#public_shdk_pop").modal({title:"审核",id:"shdk_pop",ibox_top:$(".zs-zyjg-header").height()+22,ibox_left:0.1,overlay:false,showMin:false,showMax:false,showTop:false,fullScreenId:"map_continer",isDrag:true,contentWidth:260,type:"clone",target:aC||"",removeCallBack:function(){$(".zs-toolbar .tool-cx,.zs-toolbar .tabs").show();$(".zs-tree-box.zyjg.mapToolJl").show();$(".tool-sh").removeClass("selected");i("98");$(".tool-qc").click()},addCallBack:function(){var aH=this;$("#shdk_pop").height($(".zs-zyjg-body.isyyzx").height()-22);$(".zs-toolbar .tool-cx,.zs-toolbar .tabs").hide();$(".zs-tree-box.zyjg.mapToolJl").hide();ad.dispatchEvent("CLEAR");i("1");$(".zs-nicescroll").niceScroll({cursorcolor:"#777",cursorborder:"none",});$(".zs-btn.tg-button").click(function(aI){aw(1)});$(".zs-btn.cz-button").click(function(aI){aw(3)});$(".zs-btn.bsbh-button").click(function(aI){aw(-1)})}});aG.click()}function aw(aG){window.openAlert();var aD=$("#popIbox_shdk")[0];var aC=aD.getElementsByTagName("input");var aM={};for(var aI=0;aI<aC.length;aI++){var aJ=aC[aI];if(aJ.name&&aJ.name!="lon"&&aJ.name!="lat"){aM[aJ.name]=aJ.value}}if(aG==0){for(var aF in aM){if(typeof aF!="string"){continue}if(aM[aF]!=l[aF]){aG=1;break}}}var aN=y.features[0];aN.setProperties(aM);var aE=new ol.format.WKT();var aL=aE.writeFeature(aN);aM.C_OBJINFO=aL;aM.ID=aN.getProperties().ID;aM.C_STATUS=aG+"";aM.D_EDITTIME=ad.getLocalDate();aM.C_CHECKUSERID=userObj.userId;aM.DT_CHECKTIME=ad.getLocalDate();delete aM.C_OBJINFO;var aH={addRows:null,updateRows:[aM],delRows:null,type:"updateParam",tableName:"ZYJG_BHTB",xianCode:aM.C_XIAN,y:aM.I_LAT_DEG,x:aM.I_LON_DEG};var aK={xian:aM.C_XIAN,id:aM.ID};$.ajax({url:"shdk/shdkData.do",type:"POST",data:{data:JSON.stringify(aK)},success:function(aO){if("1"==aO){$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(aH)},success:function(aT){if(aT.success){if(y.queryWhereArr.indexOf(aG)==-1){var aP=y.features[0].get("C_XIAN")+"_"+y.features[0].get("C_WORKYEAR");var aS=y.getLayerByName(aP).getSource();aS.removeFeature(y.features[0]);aS.refresh()}else{y.features[0].set("C_STATUS",aG)}for(var aR=0;aR<y.features.length;aR++){var aQ=y.features[aR].getProperties().C_STATUS+"";y.features[aR].setStyle(y.shStyleObj[aQ])}var aS=map.getLayerByName("HIGH_LAYER");if(aS&&y.features&&aS.getSource().getFeatures().length>0){for(var aR=0;aR<y.features.length;aR++){aS.getSource().clear();aS.getSource().refresh()}}y.features=[];mini.alert("审核成功！")}X();window.closeAlert()},error:function(aP){ad.validateSession(aP);window.closeAlert();console.log(aP);mini.alert("审核失败！")}})}else{window.closeAlert();mini.alert("当前小班已审核！")}},error:function(aO){ad.validateSession(aO);window.closeAlert();console.log(aO);mini.alert("审核失败！")}})}function an(){window.openAlert();X();b();a();ar();var aH="FS_BUSINESS_USERBUSLAYERS";var aI=userObj;var aG=aI.userId;var aJ=window.appid_;var aD="I_USERID = '"+aG+"' and C_APPID ='"+aJ+"'";var aC="<option value =''>无政区数据</option>";var aK=$("#shdkSelect");aK.html(aC);var aF={callback:function(aL){if(!aL){var aM="<option value =''>无政区数据</option>";aK.html(aM)}else{if(aL.length>0){aK.html("<option value =''>--请选择--</option>"+aL[0])}else{var aM="<option value =''>无政区数据</option>";aK.html(aM)}}window.closeAlert()},exceptionHandler:function(aL){window.closeAlert();console.log("错误信息："+aL)}};var aE={tableName:aH,whereStr:aD,selectVal:""};$.ajax({url:"getReportZqList.web",type:"POST",data:{data:JSON.stringify(aE)},cache:false,dataType:"json",success:aF.callback,error:aF.exceptionHandler})}function au(aD){X();b();a();ar();var aF=$("#shdkSelect").val();var aE=Number($("#grid_width").val());var aC=Number($("#grid_height").val());if(!aF){mini.alert("请先选择需要审核的县！");return}if(!aE||!aC||aC<=0||aE<=0){mini.alert("请先输入网格长宽！");return}G=0.0001;h(aE,aC,G);am(aF,aD)}function al(){window.openAlert();var aD=$("#shdkSelect").val();var aC={xian:aD,userid:userObj.userId,datakey:"SHDKGDATA",appid:window.appid_};setTimeout(function(aE){$.ajax({type:"post",url:"shdk/getZqGridData.do",dataType:"JSON",data:{data:JSON.stringify(aC)},success:function(aX){if(!aX){au()}else{window.openAlert();X();b();a();ar();var aO=aX.extent;S=aX.grid_width_deg;H=aX.grid_height_deg;P=aX.grid_width_km;f=aX.grid_height_km;G=aX.grid_space;$("#grid_width").val(P);$("#grid_height").val(f);var aY={type:"Polygon",coordinates:[[[aO[0],aO[3]],[aO[2],aO[3]],[aO[2],aO[1]],[aO[0],aO[1]],[aO[0],aO[3]]]],crs:{type:"name",properties:{name:"EPSG:0"}}};var aG={type:"Feature",geometry:aY,properties:null};var aI=ap.readFeature(aG);A=aO;U=$.extend({},aI);ai={};var aV=[],aH={},aP=[],aW={},aQ=[],aF=[],aL=[],aT=[];O=aX.grid_data;var aK=Number(aO[0]);var aJ=Number(aO[3]);for(var aS=0;aS<O.length;aS++){var aN=Number(O[aS][0]);var aM=Number(O[aS][1])+1;var aY={type:"Polygon",coordinates:[[[aK+(aN*S),aJ-(aM*H)],[aK+((aN+1)*S)-G,aJ-(aM*H)],[aK+((aN+1)*S)-G,aJ-((aM-1)*H)-G],[aK+(aN*S),aJ-((aM-1)*H)-G],[aK+(aN*S),aJ-(aM*H)]]],crs:{type:"name",properties:{name:"EPSG:0"}}};var aG={type:"Feature",geometry:aY,properties:null};var aI=ap.readFeature(aG);aI.setProperties({index:(aS+1)});ai[(aS+1)]=$.extend({},aI);if(O[aS][2]=="0"){var aU=$.extend({},aI);aU.setStyle(u);aP.push(aU);aW[(aS+1)]=aU;var aR=ax((aS+1),aY.coordinates[0][1],M,[1.4,1.5]);aL.push(aR);aT[(aS+1)]=aR}else{if(O[aS][2]=="1"){var aU=$.extend({},aI);aU.setStyle(t);aV.push(aU);aH[(aS+1)]=aU;var aR=ax((aS+1),aY.coordinates[0][1],n,[1.2,1.5]);aQ.push(aR);aF[(aS+1)]=aR}}}N.addFeatures(aQ);N.idIndex_=aF;Q.addFeatures(aL);Q.idIndex_=aT;ah.addFeatures(aV);ah.idIndex_=aH;ao.addFeatures(aP);ao.idIndex_=aW;ai.length=O.length;at();$("#shdk_grid_total").val(ai.length);$("#shdk_grid_current").val(1);x=1;ab(x,1);s(x);$("#shdk_grid_current").val(ai[x].getProperties().index);window.closeAlert()}},error:function(aF){ad.validateSession(aF);console.log(aF);window.closeAlert()}})},100)}function d(){var aF={extent:A,grid_width_km:P,grid_height_km:f,grid_width_deg:S,grid_height_deg:H,grid_space:G,grid_data:O};var aE=$("#shdkSelect").val();var aC={xian:aE,userid:userObj.userId,appid:window.appid_,datakey:"SHDKGDATA",jsondata:aF};var aD="";$.ajax({type:"post",url:"shdk/saveZqGridData.do",dataType:"JSON",data:{data:JSON.stringify(aC)},success:function(aG){console.log("保存网格信息成功")},error:function(aG){ad.validateSession(aG);console.log(aG);mini.alert("保存失败")}})}function am(aD,aC){window.openAlert();setTimeout(function(){$.ajax({type:"GET",url:T.publicService+"/ws/rest/LS/search/"+aD,dataType:"JSON",success:function(aI){if(!aI){return}var aO=ap.readFeature(aI.item.shape);aO.setStyle(I);var aN=aO.getGeometry().getExtent();A=aN;U=$.extend({},aO);aj();var aF=aN[0]-E;var aE=aN[1];var aM=aN[2];var aK=aN[3]+D;c=[];var aL=0,aJ=0;for(var aH=aF;aH<=(aM+S);aH+=S){c[aL]=[];for(var aG=aK;aG>=(aE-H);aG-=H){c[aL][aJ]={grid_col:aH,grid_row:aG,del:false,finished:false};aJ++}if(aH<=aM){aJ=0}aL++}c.width=aL-1;c.height=aJ-1;z(aC)},error:function(aE){ad.validateSession(aE);console.log(aE)}})},100)}function z(aK){ai={};var aL=[],aJ={};for(var aI=0;aI<(c.length-1);aI++){for(var aG=0;aG<(c[aI].length-1);aG++){var aH={type:"Polygon",coordinates:[[[c[aI+1][aG]["grid_col"]-G,c[aI][aG]["grid_row"]],[c[aI+1][aG]["grid_col"]-G,c[aI][aG+1]["grid_row"]+G],[c[aI][aG]["grid_col"],c[aI][aG+1]["grid_row"]+G],[c[aI][aG]["grid_col"],c[aI][aG]["grid_row"]],[c[aI+1][aG]["grid_col"]-G,c[aI][aG]["grid_row"]]]],crs:{type:"name",properties:{name:"EPSG:0"}}};var aC={type:"Feature",geometry:aH,properties:null};var aO=ap.readFeature(aC);aO.setStyle(u);ai[aG*c.width+(aI+1)]=aO}}var aD=[];var aE=1;for(var aN in ai){if(typeof aN=="string"){ai[aN].setProperties({index:aE});ai[aN].setStyle(u);aD.push(ai[aN]);var aM=ax(aE,aH.coordinates[0][1],M,[1.4,1.5]);aL.push(aM);aJ[aE]=aM;if(aE==1&&aK){var aF=$.extend(true,{},ai[aN]);aF.setStyle(I);Z.idIndex_[aE]=aF;Z.addFeature(aF)}aE++}}ai.length=aD.length;ao.addFeatures(aD);ao.idIndex_=$.extend({},ai);Q.addFeatures(aL);Q.idIndex_=aJ;N.refresh();if(!aK){d();$("#shdk_grid_total").val(ai.length);$("#shdk_grid_current").val(1);x=1;ab(x,1);s(x);$("#shdk_grid_current").val(ai[x].getProperties().index)}else{$(".zs-btn.qt-grid-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.fd-grid-button").removeClass("disabled").attr("disabled",false);window.closeAlert()}}function ab(aJ,aI){aJ=Number(aJ);var aF=$(".zs-grid-tool .dhfw input:checked");if(aF.attr("value")=="part"){X();a();ar()}var aH="";var aE=$(".zs-grid-tool .line.wcqk input:checked");var aD=ai.length;for(var aG=aJ;true;aG=(aG+aI)){var aH="";if(aE.length==2){aH=ai[aG]}else{if(aE.length==1){if(aE.attr("value")=="ywc"&&ah.getFeatures().length!=0){aH=ah.getFeatureById(aG)}else{if(aE.attr("value")=="wwc"&&ao.getFeatures().length!=0){aH=ao.getFeatureById(aG)}else{return}}}else{return}}if(aH){x=aG;aJ=aG;break}if(aG<=-1){aG=(aD+1)}else{if(aG>=(aD+1)){aG=0}}}if(aH){var aC=Z.getFeatureById(aJ);if(aC){}else{Z.clear();Z.idIndex_={};aC=$.extend({},ai[aJ]);aC.setStyle(I);Z.idIndex_[aJ]=aC;Z.addFeature(aC)}F()}}function s(aF){window.closeAlert();return;try{var aD="";var aC=$(".zs-grid-tool .dhfw input:checked");if(aC.attr("value")=="all"){aD=A}else{if(aC.attr("value")=="part"){aD=ai[aF].getGeometry().getExtent()}}j(aD)}catch(aE){}}function j(aF){var aH="2017";var aG=$("#shdkSelect").val();var aD=T.publicService+"/ws/rest/DS/export/zyjg/";var aE="";var aC=$(".zs-grid-tool .line.shzt input:checked");aC.each(function(aI){aE+=aC[aI].value+","});if(!aE){aE="999"}aE=aE.substring(0,aE.length-1);aD+=aF[0]+"/"+aF[1]+"/"+aF[2]+"/"+aF[3]+"/"+aH+"/"+aG+"/"+aE;window.openAlert();$.ajax({url:aD,type:"GET",success:function(aL){if(aL.message=="sucess"){var aM=[];var aN=aL.data;ak=[];aA={};g=0;for(var aK=0;aK<aN.length;aK++){if(aN[aK].lon&&aN[aK].lat&&aN[aK].lon.length>6&&aN[aK].lat>6){g++;ak.push(aN[aK].id);var aJ=aN[aK].c_xiang+aN[aK].c_cun+aN[aK].c_xiaoban+"小班";aA[aN[aK].id]={lon:aN[aK].lon,lat:aN[aK].lat,name:aJ}}}ak=ak.sort();var aO=$("#shdk_current");var aI=$("#shdk_total");aO.val("0");aI.val("0");$("#shtbSelect").html("<option value =''>无图斑数据</option>");if(g>0){aO.val("1");aI.val(g);r();ay(aA[ak[0]])}else{aB.clear();y.features=[];window.closeAlert()}}else{window.closeAlert()}},error:function(aI){}})}function p(){var aE=$("#shtbSelect").val();var aD=0;for(var aC in aA){if(typeof aC=="string"){aD++;if(aC==aE){break}}}X();$("#shdk_current").val(aD);ay(aA[aE])}function r(){var aF=$("#shtbSelect");if(!aA){aF.html("<option value =''>无图斑数据</option>");return}var aE="";var aD=0;for(var aC in aA){if(typeof aC=="string"){aD++;aE+="<option oid='"+aD+"' value ='"+aC+"'>"+aA[aC]["name"]+"</option>"}}aF.html(aE)}function ay(aE){X();aB.clear();y.features=[];var aD=[aE.lon,aE.lat];var aC=aE.name;if(!aD||!(Number(aD[0])&&Number(aD[1]))){mini.alert("坐标不正确！");window.closeAlert();return}$(".zs-btn.xyg-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.syg-button").removeClass("disabled").attr("disabled",false);var aF=function(aH){if(typeof aH=="object"&&aH.success){var aL=JSON.parse(aH.data);var aJ=$("#popIbox_shdk")[0];if(aJ){var aK=aJ.getElementsByTagName("input");l=aL;aK.C_XIAN.value=aL.C_XIAN||"";aK.C_XIANNAME.value=aL.C_XIANNAME||"";aK.C_XIANG.value=aL.C_XIANG||"";aK.C_CUN.value=Number(aL.C_CUN)?(Number(aL.C_CUN)):(aL.C_CUN||"");aK.C_XIAOBAN.value=Number(aL.C_XIAOBAN)?(Number(aL.C_XIAOBAN)):(aL.C_XIAOBAN||"");aK.C_WORKYEAR.value=aL.C_WORKYEAR||"";aK.I_LON_DEG.value=aD[0];var aI=ad.getDFM(aD[0]);aK.lon.value=aI[0]+"°"+aI[1]+"′"+aI[2]+"″";aK.I_LAT_DEG.value=aD[1];var aG=ad.getDFM(aD[1]);aK.lat.value=aG[0]+"°"+aG[1]+"′"+aG[2]+"″";aK.D_AREA.value=aL.D_AREA||"";aK.C_YSBHYY.value=aL.C_YSBHYY||"";$(aK.C_YSBHYY).siblings().val(aL.C_YSBHYY);aK.C_HSBHYY.value=aL.C_HSBHYY||"";$(aK.C_HSBHYY).siblings().val(aL.C_HSBHYY);aK.C_YIJU.value=aL.C_YIJU||"";aK.C_USERNAME.value=aL.C_USERNAME||"";aK.DT_CREATETIME.value=aL.DT_CREATETIME||"";aK.C_CHECKUSERNAME.value=userObj.realName||aL.C_CHECKUSERNAME;aK.DT_CHECKTIME.value=ad.getDate("yyyy-MM-dd")||aL.DT_CHECKTIME;aK.C_STATUS_DESC.value=aL.C_STATUS_DESC||"";if([1,2,-1].indexOf(aL.C_STATUS)==-1){$(".zs-btn.tg-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.cz-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.bsbh-button").removeClass("disabled").attr("disabled",false)}}ag(aL)}else{if(y.features.length!=0){aB.clear();y.features=[]}}window.closeAlert()};window.openAlert();aa.queryBySpace(aD,"2017",{queryType:"bhdk"},aF)}function ae(){var aD=Z.getFeatures();if(aD&&aD.length>0){for(var aC in Z.idIndex_){if(typeof aC=="string"){ab(aC,0);s(x);$("#shdk_grid_current").val(ai[x].getProperties().index)}}}}function W(aD){var aE=$("#shdk_current");var aC=0;if(!aD){aC=Number(aE.val())+1}else{aC=Number(aE.val())-1}if(aC<=0){aC=ak.length}else{if(aC>ak.length){aC=1}}aE.val(aC);$("#shtbSelect").val(ak[aC-1]);ay(aA[ak[aC-1]])}function ac(aC){var aE,aF;if(aC){aE=A;aF=U.getGeometry()}else{var aD=Z.getFeatures();if(aD&&aD.length>0){aF=aD[0].getGeometry();aE=aF.getExtent()}else{return}}if(aE.length!=0){map.getMap().getView().fit(aE)}}function az(aC){var aF=$("#shdk_grid_current");if(aC){x=Number(x)-1;ab(x,-1)}else{x=Number(x)+1;ab(x,1)}var aD=$(".zs-grid-tool .dhfw input:checked");if(aD.attr("value")=="part"){s(x)}$("#shdk_grid_current").val(ai[x].getProperties().index);var aE=map.getMap().getView().getZoom();if(aE>12){$(".fd-grid-button").click()}}function L(){var aE=Number($("#shdk_current").val());if(!aE||aE<1||aE>ak.length){$("#shdk_current").val($("#shtbSelect :checked").attr("oid"));return}aE=Math.floor(aE);$("#shdk_current").val(aE);var aD=0;for(var aC in ak){if(typeof aC=="string"){aD++;if(aD==aE){aD=aC;break}}}$("#shtbSelect").val(ak[aD]);ay(aA[ak[aD]])}function R(){var aG=Number($("#shdk_grid_current").val());if(!aG||aG<1||aG>ai.length){$("#shdk_grid_current").val(x);return}aG=Math.floor(aG);$("#shdk_current").val(aG);var aD=$(".zs-grid-tool .line.wcqk input:checked");var aC=[];if(aD.length==2){aC=ai}else{if(aD.length==1){if(aD.attr("value")=="ywc"){aC=ah.idIndex_}else{if(aD.attr("value")=="wwc"){aC=ao.idIndex_}}}else{return}}for(var aF in aC){if(typeof aF=="string"){if(aC[aF]&&aC[aF].getProperties().index==aG){x=aF;break}}}ab(x,0);var aE=$(".zs-grid-tool .dhfw input:checked");if(aE.attr("value")=="part"){s(x)}}function av(aJ){var aG=ai[aJ];if(aG){var aD=ah.getFeatureById(aJ);var aH="";var aI=0;if(!aD){delete ao.idIndex_[aJ];ao.removeFeature(aG);aG.setStyle(t);ah.idIndex_[aJ]=aG;ah.addFeature(aG);ah.refresh();Q.removeFeature(Q.idIndex_[aJ]);delete Q.idIndex_[aJ];var aC=ax(aJ,aG.getGeometry().getCoordinates()[0][1],n,[1.2,1.5]);N.idIndex_[aJ]=aC;N.addFeature(aC);N.refresh();aI=1}else{if(aD){delete ah.idIndex_[aJ];ah.removeFeature(aD);aG.setStyle(u);ao.idIndex_[aJ]=aG;ao.addFeature(aG);ao.refresh();N.removeFeature(N.idIndex_[aJ]);delete N.idIndex_[aJ];var aC=ax(aJ,aG.getGeometry().getCoordinates()[0][1],M,[1.4,1.5]);Q.idIndex_[aJ]=aC;Q.addFeature(aC);Q.refresh();aI=0}}at();var aF=0;for(var aE in ai){if(typeof aE=="string"&&aE!="length"){aF++;if(aE==aJ){O[(aF-1)][2]=aI;d();break}}}}}function at(){var aF=$(".zs-grid-tool .line.wcqk input:checked");if(aF.length==2){var aH=0;for(var aG in ai){if(typeof aG=="string"&&aG!="length"){aH++;var aJ=ah.getFeatureById(aG);if(aJ){aJ.setProperties({index:aH});var aE=N.getFeatureById(aG);aE.getStyle().text_.text_=aH+"";N.refresh()}var aD=ao.getFeatureById(aG);if(aD){aD.setProperties({index:aH});var aE=Q.getFeatureById(aG);aE.getStyle().text_.text_=aH+"";Q.refresh()}}}$("#shdk_grid_total").val(ai.length);var aI=Z.getFeatures()[0];if(aI){$("#shdk_grid_current").val(aI.get("index"))}}else{if(aF.length==1){var aH=0;for(var aG in ah.idIndex_){if(typeof aG=="string"&&aG!="length"){aH++;var aJ=ah.getFeatureById(aG);if(aJ){aJ.setProperties({index:aH});var aE=N.getFeatureById(aG);aE.getStyle().text_.text_=aH+"";N.refresh()}}}aH=0;for(var aG in ao.idIndex_){if(typeof aG=="string"&&aG!="length"){aH++;var aJ=ao.getFeatureById(aG);if(aJ){aJ.setProperties({index:aH});var aE=Q.getFeatureById(aG);aE.getStyle().text_.text_=aH+"";Q.refresh()}}}var aC=0;if(aF.attr("value")=="ywc"){aC=ah.getFeatures().length}else{if(aF.attr("value")=="wwc"){aC=ao.getFeatures().length}}$("#shdk_grid_total").val(aC);ab(x,1);s(x)}else{$("#shdk_grid_total").val(0);$("#shdk_grid_current").val(0)}}}function w(){var aC=$(".zs-grid-tool .line.wcqk input:checked");var aE=map.getMap().getView().getZoom();var aG=map.getLayerByName("SHDK_YWC_LAYER");var aI=map.getLayerByName("SHDK_WWC_LAYER");var aF=map.getLayerByName("SHDK_P_YWC_LAYER");var aH=map.getLayerByName("SHDK_P_WWC_LAYER");if(aC.length==0){aG.setVisible(false);aI.setVisible(false);aF.setVisible(false);aH.setVisible(false)}if(aC.length==1){var aD={};if(aC.attr("value")=="ywc"){aI.setVisible(false);aG.setVisible(true);aH.setVisible(false);if(aE>15){aF.setVisible(true)}else{aF.setVisible(false)}}if(aC.attr("value")=="wwc"){aI.setVisible(true);aG.setVisible(false);aF.setVisible(false);if(aE>15){aH.setVisible(true)}else{aH.setVisible(false)}}}if(aC.length==2){aG.setVisible(true);aI.setVisible(true);if(aE>15){aF.setVisible(true);aH.setVisible(true)}else{aF.setVisible(false);aH.setVisible(false)}}}function ag(aG){var aE=aG.C_XIAN+"_"+aG.C_WORKYEAR;if(!y.getLayerByName(aE)){var aC=B.getTree("zyjg");K(aC.getNodes()[0],aE)}var aD={type:"Feature",geometry:JSON.parse(aG.shape),properties:{ID:aG.ID+"",C_XIAN:aG.C_XIAN,C_WORKYEAR:aG.C_WORKYEAR,C_STATUS:aG.C_STATUS,I_CREATEUSERID:aG.I_CREATEUSERID}};var aF=ap.readFeature(aD);y.features.push(aF);aF.setStyle(I);aB.addFeature(aF);map.getMap().getView().fit(aF.getGeometry().getExtent());map.getMap().getView().setZoom(14);!aG.C_STATUS?aG.C_STATUS="0":"0";i(aG.C_STATUS)}function K(aE,aC){if(aE.children&&aE.children.length>0){for(var aD=0;aD<aE.children.length;aD++){K(aE.children[aD],aC)}}else{if(aE.selectId&&aE.selectId==aC){var aF=$("[tid='"+aE.id+"'] i");if(!aF.parent("a").hasClass("selected")){$("[tid='"+aE.id+"'] i").click()}}}}function af(aN){var aH=typeof aN.C_NR=="object"?aN.C_NR:JSON.parse(aN.C_NR);var aE={};var aG="<div class='zs-nicescroll'><form id='popIbox_shdk'><table class='fore-common-form-tabs'";window.optionClick=e;for(var aF=0;aF<aH.length;aF++){var aJ=aH[aF];aG+="<tr><td class='text'>"+aJ.DICTNAME+"</td>";var aM=aE[aJ.FIELDNAME]?aE[aJ.FIELDNAME]:"";if(aJ.GROUP){aG+="<td class='input'>";var aI=aJ.GROUP;for(var aK=0;aK<aI.length;aK++){var aO=aI[aK];var aC=aE[aO.FIELDNAME]?aE[aO.FIELDNAME]:"";aG+="<input type='text' style='width:35px;' name= '"+aO.FIELDNAME+"'value='"+aC+"'/> "+aO.DICTNAME+" "}aG+="</td></tr>"}else{if(aJ.DICTITEM){var aL=aJ.DICTITEM;aG+="<td class='input'><input type='hidden' value='"+aM+"' name='"+aJ.FIELDNAME+"'/><select style='width:100px;' onchange='optionClick(this)'><option value=''>--请选择--</option>";for(var aD=0;aD<aL.length;aD++){var aO=aL[aD];if(aM==aO.NAME){aG+="<option selected='selected' value='"+aO.NAME+"'>"+aO.NAME+"</option>"}else{aG+="<option value='"+aO.NAME+"'>"+aO.NAME+"</option>"}}aG+="</select></td></tr>"}else{if(aJ.FIELDNAME=="I_LON_DEG"){aG+="<td class='input'><input type='hidden' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/><input type='text' style='width:100px;' value='' name='lon'/></td></tr>"}else{if(aJ.FIELDNAME=="I_LAT_DEG"){aG+="<td class='input'><input type='hidden' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/><input type='text' style='width:100px;' value='' name='lat'/></td></tr>"}else{if(aJ.FIELDNAME=="C_XIAN"){aG+="<td class='input'><input type='hidden' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/><input type='text'    style='width:100px;' value='' name='C_XIANNAME'/></td></tr>"}else{if(aJ.FIELDNAME=="C_USERNAME"){aG+="<td class='input'><input type='text' disabled='disabled' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}else{if(aJ.FIELDNAME=="DT_CREATETIME"){aG+="<td class='input'><input type='text' style='width:100px;'  disabled='disabled' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}else{if(aJ.FIELDNAME=="C_CHECKUSERNAME"){aG+="<td class='input'><input type='text' disabled='disabled' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}else{if(aJ.FIELDNAME=="DT_CHECKTIME"){aG+="<td class='input'><input type='text' style='width:100px;'  disabled='disabled' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}else{if(aJ.FIELDNAME=="C_STATUS_DESC"){aG+="<td class='input'><input type='text' style='width:100px;'  disabled='disabled' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}else{aG+="<td class='input'><input type='text' style='width:100px;' value='"+aM+"' name='"+aJ.FIELDNAME+"'/></td></tr>"}}}}}}}}}}}aG+="</table></form></div>";aG+="<div class='fore-core-btnboxs'><button class='zs-btn disabled tg-button' disabled='disabled' style='padding: 0px 10px;'>通过</button><button class='zs-btn disabled cz-button' disabled='disabled' style='padding: 0px 10px;'>重做</button><button class='zs-btn disabled bsbh-button' disabled='disabled' style='padding: 0px 10px;'>不是变化</button></div>";return aG}function e(aC){$(aC).siblings("input").val(aC.value)}function i(aD){var aH=$(".board-qh a");var aE=[];if(aD){switch(aD){case"0":aE=["tool-cj","tool-fg","tool-hb","tool-sc","tool-sx"];break;case"1":aE=["tool-cj","tool-xb","tool-jdbj","tool-fg","tool-hb","tool-sc","tool-sx"];break;case"2":aE=["tool-cj","tool-xb","tool-jdbj","tool-fg","tool-hb","tool-sc","tool-sx"];break;case"3":aE=["tool-cj","tool-fg","tool-hb","tool-sc","tool-sx"];break;case"-1":aE=["tool-cj","tool-fg","tool-hb","tool-sc","tool-sx"];break;case"98":break}}else{aE=["tool-cj","tool-xb","tool-jdbj","tool-fg","tool-hb","tool-sc","tool-sx"]}var aC=aH.length;for(var aF=0;aF<aC;aF++){var aG=aH[aF];if(aG.className.indexOf("tool-ht")<0){$(aG).removeClass("disable")}if(aE.contains(aG.className)){$(aG).addClass("disable")}}}function h(aF,aD,aE){P=aF;f=aD;var aC=360/(6371000*2*Math.PI);S=aF*1000*aC;H=aD*1000*aC;G=aE*1000*aC}function J(){var aC=$.extend({},ai);var aF=new jsts.io.OL3Parser();var aJ=aF.read(U.getGeometry());var aH=0;O=[];var aE=new Date().getTime();for(var aG in aC){if(typeof aG=="string"){var aI=aF.read(aC[aG].getGeometry());var aD=aI.intersection(aJ);if(aD.getArea()<=0){delete ai[aG]}else{O[aH]=[(aG-1)%c.width,Math.floor(aG/c.width),0];aH++}}}console.log(new Date().getTime()-aE)}function X(){var aD=document.getElementById("popIbox_shdk");if(aD){var aE=aD.getElementsByTagName("input");for(var aC=0;aC<aE.length;aC++){aE[aC].value=""}var aE=aD.getElementsByTagName("select");for(var aC=0;aC<aE.length;aC++){aE[aC].value=""}}$(".zs-btn.tg-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.cz-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.bsbh-button").addClass("disabled").attr("disabled","disabled")}function b(){ah.clear();ao.clear();Z.clear();N.clear();Q.clear();ah.idIndex_={};ao.idIndex_={};Z.idIndex_={};N.idIndex_={};Q.idIndex_={};aB.clear();y.features=[]}function a(){$(".zs-btn.qt-grid-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.fd-grid-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.syg-grid-button.prev").removeClass("line").addClass("disabled").attr("disabled","disabled");$(".zs-btn.xyg-grid-button.next").removeClass("line").addClass("disabled").attr("disabled","disabled");$(".zs-btn.shwg-grid-button.endLeft").addClass("disabled").attr("disabled","disabled");$("#shdk_grid_current").val("0");$("#shdk_grid_total").val("0")}function ar(){$(".zs-btn.syg-button.prev").removeClass("line").addClass("disabled").attr("disabled","disabled");$(".zs-btn.xyg-button.next").removeClass("line").addClass("disabled").attr("disabled","disabled");$("#shdk_current").val("0");$("#shdk_total").val("0");$("#shtbSelect").html("<option value =''>无图斑数据</option>")}function F(){$(".zs-btn.qt-grid-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.fd-grid-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.syg-grid-button.prev").addClass("line").removeClass("disabled").attr("disabled",false);$(".zs-btn.xyg-grid-button.next").addClass("line").removeClass("disabled").attr("disabled",false);$(".zs-btn.shwg-grid-button.endLeft").removeClass("disabled").attr("disabled",false);if(ai[x]){$("#shdk_grid_current").val(ai[x].getProperties().index)}var aC=$(".zs-grid-tool .line.wcqk input:checked");if(aC.length==2){$("#shdk_grid_total").val(ai.length)}else{if(aC.length==1){if(aC.attr("value")=="ywc"){$("#shdk_grid_total").val(ah.getFeatures().length)}else{if(aC.attr("value")=="wwc"){$("#shdk_grid_total").val(ao.getFeatures().length)}}}else{$("#shdk_grid_total").val(0)}}}function C(){$(".zs-btn.syg-button.prev").addClass("line").removeClass("disabled").attr("disabled",false);$(".zs-btn.xyg-button.next").addClass("line").removeClass("disabled").attr("disabled",false);$("#shdk_current").val("0");$("#shdk_total").val("0");$("#shtbSelect").html("<option value =''>无图斑数据</option>")}function aq(aD){var aC=ah.getFeatures();for(var aE=0;aE<aC.length;aE++){if(!aD){aC[aE].getStyle().fill_.color_="rgba(255,255,255,0.5)"}else{aC[aE].getStyle().fill_.color_="rgba(255,255,255,0)"}}ah.refresh()}function ax(aG,aC,aF,aD){var aC=new ol.Feature(new ol.geom.Point(aC));var aE=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0)"}),image:new ol.style.Icon({anchor:aD,src:aF}),text:new ol.style.Text({text:aG+"",font:"30px serif",offsetX:"-70",offsetY:"-50",fill:new ol.style.Fill({color:"red"}),stroke:new ol.style.Stroke({color:"white",width:3})})});aC.setStyle(aE);return aC}function o(){var aE=map.getMap().getView();var aH=aE.getZoom();if(aH<15){mini.alert("请把地图放大到合适比例，再创建网格!");return}var aG=aE.calculateExtent();var aF=aG[2]-aG[0];var aD=aG[3]-aG[1];var aI=aD*0.25;S=aF-aI;H=aD-aI;var aC=6371000*2*Math.PI/360/1000;P=aC*S;f=aC*H;return[P,f]}function aj(){var aD=map.getMap().getView();var aF=aD.getZoom();if(aF<15){E=0;D=0;return}var aE=aD.calculateExtent();var aC=aE[3]-aE[1];var aI=aC*0.25;var aG=(aE[0]-A[0]+(aI/2))/S;var aH=(A[3]-aE[3]+(aI/2))/H;E=(1-(aG-Math.floor(aG)))*S;D=(1-(aH-Math.floor(aH)))*H}function v(aD,aC){$(".zs-btn.tg-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.cz-button").addClass("disabled").attr("disabled","disabled");$(".zs-btn.bsbh-button").addClass("disabled").attr("disabled","disabled");$.ajax({url:"shdk/getDataById.do",type:"POST",data:{data:JSON.stringify({xian:aC,id:aD})},success:function(aF){if(aF){var aJ=JSON.parse(aF);if(aJ.C_STATUS&&aJ.C_STATUS.length>0){aJ.C_STATUS_DESC=m[aJ.C_STATUS]}var aH=$("#popIbox_shdk")[0];if(aH){var aI=aH.getElementsByTagName("input");l=aJ;aI.C_XIAN.value=aJ.C_XIAN||"";aI.C_XIANNAME.value=aJ.C_XIANNAME||"";aI.C_XIANG.value=aJ.C_XIANG||"";aI.C_CUN.value=Number(aJ.C_CUN)?(Number(aJ.C_CUN)):(aJ.C_CUN||"");aI.C_XIAOBAN.value=Number(aJ.C_XIAOBAN)?(Number(aJ.C_XIAOBAN)):(aJ.C_XIAOBAN||"");aI.C_WORKYEAR.value=aJ.C_WORKYEAR||"";aI.I_LON_DEG.value=aJ.I_LON_DEG;var aG=ad.getDFM(aJ.I_LON_DEG);aI.lon.value=aG[0]+"°"+aG[1]+"′"+aG[2]+"″";aI.I_LAT_DEG.value=aJ.I_LAT_DEG;var aE=ad.getDFM(aJ.I_LAT_DEG);aI.lat.value=aE[0]+"°"+aE[1]+"′"+aE[2]+"″";aI.D_AREA.value=aJ.D_AREA||"";aI.C_YSBHYY.value=aJ.C_YSBHYY||"";$(aI.C_YSBHYY).siblings().val(aJ.C_YSBHYY);aI.C_HSBHYY.value=aJ.C_HSBHYY||"";$(aI.C_HSBHYY).siblings().val(aJ.C_HSBHYY);aI.C_YIJU.value=aJ.C_YIJU||"";aI.C_USERNAME.value=aJ.C_USERNAME||"";aI.DT_CREATETIME.value=ad.getDate("yyyy-MM-dd",new Date(aJ.DT_CREATETIME))||"";aI.C_CHECKUSERNAME.value=userObj.realName||aJ.C_CHECKUSERNAME;aI.DT_CHECKTIME.value=ad.getDate("yyyy-MM-dd")||aJ.DT_CHECKTIME;aI.C_STATUS_DESC.value=aJ.C_STATUS_DESC||"";if([1,2,-1].indexOf(aJ.C_STATUS)==-1){$(".zs-btn.tg-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.cz-button").removeClass("disabled").attr("disabled",false);$(".zs-btn.bsbh-button").removeClass("disabled").attr("disabled",false)}}}else{window.closeAlert()}},error:function(aE){ad.validateSession(aE);window.closeAlert();mini.alert("查询失败！")}})}return{init:V,getDataById:v,}});
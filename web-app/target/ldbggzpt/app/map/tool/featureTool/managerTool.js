define(["map","util","config","publicObj","addTool","selectTool","modifyTool","paramTool","analyzeTool","queryLayer","unionTool","splitTool","cutTool","burrowTool","measureMap"],function(x,f,F,v,J,g,L,b,P,K,d,I,c,n,r){var q=new ol.format.WKT();var t=new jsts.io.OL3Parser();var Q;var y;var e;var S;var m=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0)"}),stroke:new ol.style.Stroke({color:"rgb(255,255,0)",width:3})});var O=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0)"}),stroke:new ol.style.Stroke({color:"rgb(255,0,0)",width:3})});function u(W){window.startTool=true;e=S;$("#map").removeClass("movehand");if(W==="select"){if(e=="move"){C(false)}else{C(true)}g.setActive(true,o)}else{if(W==="move"){window.startTool=false;C(false);g.setActive(false);$("#map").addClass("movehand")}else{if(W==="clear"){C(true);s()}else{if(W==""){}else{var X=k();$("#map").removeClass("noTrack");$("#map").removeClass("Track");$("#map").removeClass("movehand");switch(W){case"add":C(true);J.setActive(true,T);break;case"trim":if(X.length===1){C(false);I.setActive(true,X[0],D)}else{C(true);s();mini.alert("请选择一个图形，进行修边！","温馨提示")}break;case"modify":if(X.length===1){C(false);g.setActive(false);L.setActive(true,A,X[0])}else{C(true);s();mini.alert("请选择一个图形！","温馨提示")}break;case"cut":if(X.length===1){C(false);c.setActive(true,X[0],h)}else{C(true);s();mini.alert("请选择一个图形，进行分割！","温馨提示")}break;case"burrow":if(X.length===1){C(false);n.setActive(true,X[0],a)}else{C(true);s();mini.alert("请选择一个图形，进行分割！","温馨提示")}break;case"union":if(X.length==2){C(false);var Y=d.union(X,R)}else{C(true,true);s();$(".tool  .selected").removeClass("selected");mini.alert("请选择两个图形，进行合并！","温馨提示")}break;case"del":if(X.length==1){C(false);j(X)}else{mini.alert("请选择一个图形！","温馨提示");$(".tool  .selected").removeClass("selected");C(true,true)}break;case"param":if(X.length===1){C(false);b.handler(X[0],T);if(e=="modify"){X[0].setStyle(m);$(".tool  .selected").removeClass("selected");C(true,true);s()}}else{C(true,true);s();$(".tool  .selected").removeClass("selected");mini.alert("请选择一个图形！","温馨提示")}break;case"revoke":if(e=="add"){J.undo();return}else{window.startTool=false}break}}}}}S=W}function o(){if(!$(".tool-qh").hasClass("selected")){$(".tool-qh").click()}if(v.features.length==1){z(0)}else{if(v.features.length==2){z(0);setTimeout(function(){if(!$(".tool-hb").hasClass("disable")){z(1)}},0)}else{w()}}}function z(X){var W=v.features[X].getProperties().C_STATUS+"";if(userObj.functions.indexOf("ZYJG_SH")>0){w(W)}else{if(userObj.functions.indexOf("ZYJG_PD")>0){var Y=v.features[X].getProperties().I_CREATEUSERID;if(Y==userObj.userId){w(W)}else{w()}}else{}}}function w(X){var ab=$(".board-qh a");var Y=[];if(X){switch(X){case"0":break;case"1":Y=["tool-xb","tool-jdbj","tool-fg","tool-wd","tool-hb","tool-sc","tool-sx"];break;case"2":Y=["tool-xb","tool-jdbj","tool-fg","tool-wd","tool-hb","tool-sc","tool-sx"];break;case"3":break;case"-1":break}}else{Y=["tool-xb","tool-jdbj","tool-fg","tool-wd","tool-hb","tool-sc","tool-sx"]}var W=ab.length;for(var Z=0;Z<W;Z++){var aa=ab[Z];if(aa.className.indexOf("tool-ht")<0){$(aa).removeClass("disable")}if(Y.contains(aa.className)){$(aa).addClass("disable")}}}function R(ad){window.openAlert();var aa=I.getMaxArea(k());var ae=aa.getProperties();delete ae.geometry;ae.D_AREA=f.getArea(ad.getGeometry());var ab=aa.getProperties().C_XIAN+"_"+aa.getProperties().C_WORKYEAR;var Z=v.getLayerByName(ab);var W=new ol.format.WKT();var ac=W.writeFeature(ad);var af=0;var ag=k();for(var Y=0;Y<ag.length;Y++){if(ag[Y].getProperties().ID!==aa.getProperties().ID){af=ag[Y].getProperties().ID}}ae.C_OBJINFO=ac;ae.I_EDITUSERID=userObj.userId;ae.DT_EDITTIME=f.getLocalDate();var X={addRows:null,updateRows:[ae],delRows:[af+""],type:"updateGeom",tableName:"ZYJG_BHTB",xianCode:ae.C_XIAN};$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(X)},success:function(ah){if(ah.success){}else{mini.alert("合并失败！","失败提示")}M()},error:function(ah){f.validateSession(ah);console.log(ah)}})}function h(X){window.openAlert();var Y=t.write(t.read(k()[0].getGeometry()).getInteriorPoint()).getCoordinates();var W=Y[0];var ab=Y[1];var Z=k()[0].getProperties();delete Z.geometry;var aa=function(ak){if(typeof ak=="object"&&ak.success){var af=JSON.parse(ak.data);delete af.shape;var ai=Z.C_XIAN+"_"+Z.C_WORKYEAR;var ah=v.getLayerByName(ai);var ae=new ol.format.WKT();var aj=[];for(var ag=0;ag<X.length;ag++){var ad=f.getArea(X[ag].getGeometry());var an=t.write(t.read(X[ag].getGeometry()).getInteriorPoint()).getCoordinates();var ac=an[0];var al=an[1];var am=ae.writeFeature(X[ag]);af.I_EDITUSERID=userObj.userId;af.D_EDITTIME=f.getLocalDate();af.D_AREA=ad;af.I_LON_DEG=ac;af.I_LAT_DEG=al;af.C_OBJINFO=am;X[ag].setProperties(af);aj.push(X[ag].getProperties());delete aj[ag].geometry}var af={addRows:aj,updateRows:null,delRows:[Z.ID+""],type:"cut",tableName:"ZYJG_BHTB",xianCode:aj[0].C_XIAN};$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(af)},success:function(ao){if(ao.success){}else{mini.alert("分割失败！","失败提示")}M()},error:function(ao){f.validateSession(ao);console.log(ao)}})}};K.queryBySpace([W,ab],"2017",{queryType:"bhdk"},aa)}function a(aa){var X=q.readFeature(aa);var Z=t.write(t.read(X.getGeometry()).getInteriorPoint()).getCoordinates();var W=Z[0];var ad=Z[1];var Y=f.getArea(X.getGeometry());var ac=k()[0].getProperties();delete ac.geometry;ac.C_OBJINFO=aa;ac.D_AREA=Y;ac.I_LAT_DEG=W;ac.I_LON_DEG=ad;ac.I_EDITUSERID=userObj.userId;ac.DT_EDITTIME=f.getLocalDate();var ab={addRows:null,updateRows:[ac],delRows:null,type:"burrow",tableName:"ZYJG_BHTB",xianCode:ac.C_XIAN};$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(ab)},success:function(ae){if(!ae.success){mini.alert("分割失败！","失败提示")}M()},error:function(ae){f.validateSession(ae);console.log(ae)}})}function D(aa,W){window.openAlert();var ac=[];var Y=v.features[0].getProperties();var Z=Y.C_XIAN;var ad=Y.C_WORKYEAR;var ae=Y.C_STATUS;var ai=Z+"_"+ad;var ah=v.getLayerByName(ai);for(var ag=0;ag<aa.length;ag++){var ak=t.write(t.read(aa[ag].getGeometry()).getInteriorPoint()).getCoordinates();var X=f.getArea(aa[ag].getGeometry());var al=aa[ag].getProperties();delete al.geometry;var ab=new ol.format.WKT();var aj=ab.writeFeature(aa[ag]);al.I_LON_DEG=ak[0];al.I_LAT_DEG=ak[1];al.D_AREA=X;al.C_OBJINFO=aj;al.DT_EDITTIME=f.getLocalDate();al.I_EDITUSERID=userObj.userId;al.C_XIAN=Z;al.C_WORKYEAR=ad;al.C_STATUS=ae;al.I_CREATEUSERID=Y.I_CREATEUSERID;ac.push(al);aa[ag].setProperties(al)}var af={addRows:null,updateRows:ac,delRows:W,type:"updateGeom",tableName:"ZYJG_BHTB",xianCode:Z};$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(af)},success:function(am){if(am.success){if(v.features.length===1&&$("[name='D_AREA']").length===1){$("[name='D_AREA']").val(f.getArea(feature.getGeometry()))}}else{mini.alert("保存失败！","错误提示")}M()},error:function(am){f.validateSession(am);console.log(am)}})}function T(aa,Y,Z){Q=Y;y=Z;if(window.ldyzt_fullScreen){var W="map_continer"}else{var W=null}var X=H(Y,Z);var ab=$("#public_pop").modal({title:"属性信息",overlay:false,showMin:false,showMax:false,showTop:false,isDrag:true,fullScreenId:W,contentWidth:350,type:"clone",target:X||"",addCallBack:function(){var ah=this;$(".zs-nicescroll").niceScroll({cursorcolor:"#777",cursorborder:"none",});$(".close-button").on("click",function(){$(".close-btn").click();if(S=="add"){$(".tool-qc").click()}});$(".save-button").on("click",function(){p(Y)});var ae=t.write(t.read(Y.getGeometry()).getInteriorPoint()).getCoordinates();var ag=$("#popIbox_xbsx")[0];var ai=ag.getElementsByTagName("input");if(S=="add"){ai.C_WORKYEAR.value=userObj.defineNd;ai.I_LON_DEG.value=ae[0];ai.C_USERNAME.value=userObj.realName;ai.DT_CREATETIME.value=f.getLocalDate();var af=f.getDFM(ae[0]);ai.lon.value=af[0]+"°"+af[1]+"′"+af[2]+"″";ai.I_LAT_DEG.value=ae[1];var ad=f.getDFM(ae[1]);ai.lat.value=ad[0]+"°"+ad[1]+"′"+ad[2]+"″";ai.D_AREA.value=f.getArea(Y.getGeometry());var aj=function(ao){var ar=typeof ao=="object"?ao:JSON.parse(ao);if(F.isLoacl){var an=ar.XIAN_NAME||ar.LIN_YE_JU;var aq=ar.XIAN||ar.LIN_YE_JU;var al=ar.XIANG_NAME||ar.LIN_CHANG;var am=ar.CUN_NAME||ar.LIN_BAN;var ak=ar.XIAO_BAN||""}else{if(ar.sheng_name=="云南省"){ar.xian="5"+ar.xiao_ban.substring(0,5)}if(ar.geojson){if(ar.lin_ye_ju.trim()){var an=ar.linyeju_name.trim();var aq=ar.lin_ye_ju.trim();var al=ar.lin_chang_name.trim();var am=ar.lin_ban;var ak=ar.xiao_ban||""}else{var an=ar.xian_name;var aq=ar.xian;var al=ar.xiang_name;var am=ar.cun_name;var ak=ar.xiao_ban||""}}else{var ap=G(ae[0],ae[1]);var an=ap[2]||"";var al=ap[3]||""}}ai.C_XIAN.value=(aq)||"";ai.C_XIANNAME.value=(an)||"";ai.C_XIANG.value=(al)||"";ai.C_CUN.value=Number(am)?(Number(am)):(am||"");ai.C_XIAOBAN.value=Number(ak)?(Number(ak)):(ak||"");$(".zs-btn.save-button").removeClass("disabled").attr("disabled",false)};if(F.isLoacl){var ac=F.publicService+"/ws/rest/DS/linbanpoi/zyjg/"+ae[0]+"/"+ae[1];K.query_ws(ac,aj)}else{var ac=F.queryUrl+"?";K.queryBySpace(ae,"2009",{url:ac},aj)}}else{if(S=="param"){var aj=function(al){if(typeof al=="object"&&al.success){var an=JSON.parse(al.data);ai.C_XIAN.value=an.C_XIAN||"";ai.C_XIANNAME.value=an.C_XIANNAME||"";ai.C_XIANG.value=an.C_XIANG||"";ai.C_CUN.value=Number(an.C_CUN)?(Number(an.C_CUN)):(an.C_CUN||"");ai.C_XIAOBAN.value=Number(an.C_XIAOBAN)?(Number(an.C_XIAOBAN)):(an.C_XIAOBAN||"");ai.C_WORKYEAR.value=an.C_WORKYEAR||"";ai.I_LON_DEG.value=ae[0];var am=f.getDFM(ae[0]);ai.lon.value=am[0]+"°"+am[1]+"′"+am[2]+"″";ai.I_LAT_DEG.value=ae[1];var ak=f.getDFM(ae[1]);ai.lat.value=ak[0]+"°"+ak[1]+"′"+ak[2]+"″";ai.D_AREA.value=an.D_AREA||f.getArea(Y.getGeometry());ai.C_YSBHYY.value=an.C_YSBHYY||"";$(ai.C_YSBHYY).siblings().val(an.C_YSBHYY);ai.C_HSBHYY.value=an.C_HSBHYY||"";$(ai.C_HSBHYY).siblings().val(an.C_HSBHYY);ai.C_YIJU.value=an.C_YIJU||"";ai.C_USERNAME.value=an.C_USERNAME||"";ai.DT_CREATETIME.value=an.DT_CREATETIME||""}$(".zs-btn.save-button").removeClass("disabled").attr("disabled",false)};K.queryBySpace(ae,"2017",{queryType:"bhdk"},aj)}}}});ab.click()}function H(aj,ah){var ab=typeof ah.C_NR=="object"?ah.C_NR:JSON.parse(ah.C_NR);var Y=aj.getProperties();var aa="<form id='popIbox_xbsx' style='width:300px'><table class='fore-common-form-tabs'";window.optionClick=N;for(var Z=0;Z<ab.length;Z++){var ad=ab[Z];aa+="<tr><td class='text'>"+ad.DICTNAME+"</td>";var ag=Y[ad.FIELDNAME]?Y[ad.FIELDNAME]:"";if(ad.GROUP){aa+="<td class='input'>";var ac=ad.GROUP;for(var ae=0;ae<ac.length;ae++){var ai=ac[ae];var W=Y[ai.FIELDNAME]?Y[ai.FIELDNAME]:"";aa+="<input type='text' style='width:35px;' name= '"+ai.FIELDNAME+"'value='"+W+"'/> "+ai.DICTNAME+" "}aa+="</td></tr>"}else{if(ad.DICTITEM){var af=ad.DICTITEM;aa+="<td class='input'><input type='hidden' value='"+ag+"' name='"+ad.FIELDNAME+"'/><select style='width:160px;' onchange='optionClick(this)'><option value=''>--请选择--</option>";for(var X=0;X<af.length;X++){var ai=af[X];if(ag==ai.NAME){aa+="<option selected='selected' value='"+ai.NAME+"'>"+ai.NAME+"</option>"}else{aa+="<option value='"+ai.NAME+"'>"+ai.NAME+"</option>"}}aa+="</select></td></tr>"}else{if(ad.FIELDNAME=="I_LON_DEG"){aa+="<td class='input'><input type='hidden' style='width:160px;' value='"+ag+"' name='"+ad.FIELDNAME+"'/><input type='text' style='width:160px;' value='' name='lon'/></td></tr>"}else{if(ad.FIELDNAME=="I_LAT_DEG"){aa+="<td class='input'><input type='hidden' style='width:160px;' value='"+ag+"' name='"+ad.FIELDNAME+"'/><input type='text' style='width:160px;' value='' name='lat'/></td></tr>"}else{if(ad.FIELDNAME=="C_XIAN"){aa+="<td class='input'><input type='hidden' style='width:160px;' value='"+ag+"' name='"+ad.FIELDNAME+"'/><input type='text'    style='width:160px;' value='' name='C_XIANNAME'/></td></tr>"}else{if(ad.FIELDNAME=="C_USERNAME"){aa+="<td class='input'><input type='text' disabled='disabled' style='width:160px;' value='"+ag+"' name='"+ad.FIELDNAME+"'/></td></tr>"}else{if(ad.FIELDNAME=="DT_CREATETIME"){aa+="<td class='input'><input type='text' style='width:160px;'  disabled='disabled' value='"+ag+"' name='"+ad.FIELDNAME+"'/></td></tr>"}else{aa+="<td class='input'><input type='text' style='width:160px;' value='"+ag+"' name='"+ad.FIELDNAME+"'/></td></tr>"}}}}}}}}aa+="</table></form>";aa+="<div class='fore-core-btnboxs'><button class='zs-btn close-button'>关闭</button><button class='zs-btn save-button disabled' disabled='disabled'>保存</button></div>";return aa}function N(W){$(W).siblings("input").val(W.value)}function B(){$(".close-btn").click()}function p(ag){window.openAlert();var Y=$("#popIbox_xbsx")[0];var X=Y.getElementsByTagName("input");var af={};for(var ac=0;ac<X.length;ac++){var ad=X[ac];if(ad.name&&ad.name!="lon"&&ad.name!="lat"){af[ad.name]=ad.value}}var aa=new ol.format.WKT();var ae=aa.writeFeature(ag);af.C_OBJINFO=ae;if(k().length===1){af.ID=k()[0].getProperties().ID+"";af.I_EDITUSERID=userObj.userId;af.DT_EDITTIME=f.getLocalDate();delete af.C_OBJINFO;var ab={addRows:null,updateRows:[af],delRows:null,type:"updateParam",tableName:"ZYJG_BHTB",xianCode:af.C_XIAN,y:af.I_LAT_DEG,x:af.I_LON_DEG}}else{af.C_STATUS=0;af.I_CREATEUSERID=userObj.userId;var ab={addRows:[af],updateRows:null,delRows:null,type:"insert",tableName:"ZYJG_BHTB",xianCode:af.C_XIAN,y:af.I_LAT_DEG,x:af.I_LON_DEG};var W={y:af.I_LAT_DEG,x:af.I_LON_DEG};var Z=V(af,ag,"add",W);if(!Z){return}}ag.setProperties(af);$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(ab)},success:function(ah){if(ah.success){if(ah.rowId&&ah.xianCode){x.getLayerByName("HIGH_LAYER").getSource().clear()}}else{Q=null;mini.alert("保存失败！","错误提示")}B();M()},error:function(ah){f.validateSession(ah);console.log(ah)}})}function j(W){mini.confirm("确定删除？","温馨提示",function(ac){if(ac=="ok"){window.openAlert();var Z=[];var ab=null;for(var Y=0;Y<W.length;Y++){var aa=W[Y];Z.push(aa.getProperties().ID);ab=aa.getProperties().C_XIAN}if(Z){var X={whereString:"ID in ("+Z.join(",")+")"};$.ajax({url:"app/del.do",type:"POST",data:{data:JSON.stringify({tableName:"ZYJG_BHTB",xian:ab,queryFilter:X})},success:function(ah){for(var ag=0;ag<W.length;ag++){var af=W[ag];var ad=af.getProperties().C_XIAN+"_"+af.getProperties().C_WORKYEAR;var ae=v.getLayerByName(ad);ae.getSource().removeFeature(af)}M()},error:function(ad){f.validateSession(ad);console.log(ad)}})}}else{return}})}function A(Y){window.openAlert();var ac=null;var X=new ol.format.WKT();var ad=X.writeFeature(Y);var ab=Y.getProperties();delete ab.geometry;ab.D_AREA=f.getArea(Y.getGeometry());ab.C_OBJINFO=ad;ab.DT_EDITTIME=f.getLocalDate();ab.I_EDITUSERID=userObj.userId;var W=new jsts.io.OL3Parser();if(!W.read(Y.getGeometry()).isValid()){window.closeAlert();mini.alert("图形自相交请重新绘制","温馨提示!");return}var aa=V(ab,Y,"modify");if(!aa){return}var Z={addRows:null,updateRows:[ab],delRows:null,type:"modify",tableName:"ZYJG_BHTB",xianCode:ab.C_XIAN};$.ajax({url:"dataService.do",type:"POST",data:{jsonStr:JSON.stringify(Z)},success:function(ae){window.closeAlert();if(ae.success){if(k().length===1){k()[0].setGeometry(Y.getGeometry().clone());k()[0].setProperties(ab);if($("[name='D_AREA']").length===1){$("[name='D_AREA']").val(f.getArea(Y.getGeometry()))}}}else{L.setActive(false);mini.alert("操作失败!","失败提示")}},error:function(ae){f.validateSession(ae)}})}function M(){var W="";window.closeAlert();switch(S){case"add":J.setActive(false);$(".tool-cj").removeClass("selected");$(".tool-ht").addClass("disable");break;case"param":g.clear();L.setActive(false);$(".tool-xz").removeClass("selected");break;case"del":g.clear();L.setActive(false);$(".tool-xz").removeClass("selected");break;case"union":g.clear();$(".tool-xz").removeClass("selected");break;case"cut":g.clear();c.setActive(false);$(".tool-fg").removeClass("selected");break;case"burrow":g.clear();n.setActive(false);$(".tool-wd").removeClass("selected");break;case"trim":g.clear();I.setActive(false);$(".tool-xb").removeClass("selected");break}Q=null;s();U()}function E(aa){var W=false;try{for(var Z=0;Z<aa.length;Z++){var Y=aa[Z].getProperties().C_STATUS;aa[Z].setStyle(v.shStyleObj[Y])}W=true}catch(X){}return W}function C(W){if(W){g.clear()}J.setActive(false);Q=null;I.setActive(false);L.setActive(false);c.setActive(false);n.setActive(false);r.clear();x.getLayerByName("BUFFER_LAYER").getSource().clear();x.getLayerByName("CREATE_LAYER").getSource().clear();x.getLayerByName("HIGH_LAYER").getSource().clear();window.istest_query=false;f.dispatchEvent("CLEAR")}function s(){document.getElementById("map").style.cursor="";window.startTool=false;e="";S="";$("#map").removeClass("noTrack");$("#map").removeClass("Track");$("#map").removeClass("movehand")}function U(){var W=x.getMap().getView();var X=W.getCenter();X[1]=X[1]+1e-11;W.setCenter([X[0],X[1]])}function k(){return v.features}function V(ad,aa,Z,ab){var Y=true;if(ad.C_XIAN&&ad.C_XIAN.trim().length!=0){var am=ad.C_XIAN+"_"+ad.C_WORKYEAR}else{var aj=l(ab);var am=aj+"_"+ad.C_WORKYEAR}var an=v.getLayerByName(am);var W=an.getSource().getFeatures();var ah=new jsts.io.OL3Parser();var ae=ah.read(aa.getGeometry());var ac=[];for(var ai=0;ai<W.length;ai++){var af=ah.read(W[ai].getGeometry());var al=af.intersection(ae);var ak=W[ai].getProperties();var ag="";var X=userObj.userId;if(ak){ag=ak.I_CREATEUSERID}if(al.getArea()>0&&ag!=X){ac.push(al)}}if(ac.length>0&&Z=="add"){window.closeAlert();Y=false;$(".close-btn").click();mini.alert("该图形和原有图形有相交，请重新绘制","温馨提示")}else{if(ac.length>1&&Z=="modify"){window.closeAlert();Y=false;mini.alert("该图形和原有图形有相交，请重新绘制","温馨提示")}}return Y}function l(X){var W;$.ajax({type:"GET",url:F.publicService+"/ws/rest/LS/address/5/"+X.x+"/"+X.y,async:false,dataType:"JSON",success:function(Y){W=Y.code}});return W}function G(W,Y){var X=[];$.ajax({type:"GET",url:F.publicService+"/ws/rest/LS/address/"+W+"/"+Y,async:false,dataType:"JSON",success:function(Z){if(Z){X=Z.name.split(",")}}});return X}function i(W){S=W}return{start:u,clear:C,popFun:T,changeToolType:i}});
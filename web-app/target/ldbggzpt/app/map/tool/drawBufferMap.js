define(["map","style","treeHelper","util","loadTree"],function(j,a,b,h,c){var i;var n;var l=false;var f=false;var e=null;function m(q,s){var t=j.getMap();if(!i){i=j.getLayerByName("DRAW_LAYER")}var r=i.getSource();r.clear();g();n=new ol.interaction.drawBuffer({source:r,type:q,snapTolerance:5,isBuffer:true,bufferLayerName:"LDGX_P",bufferTolerance:8,style:a.getDefaultStyleFunction()});t.addInteraction(n);n.on("drawend",function(v){if(l){setTimeout(function(){i.getSource().clear()},200);l=false;return}var u=new jsts.io.WKTReader();var w=u.read(new ol.format.WKT().writeFeature(v.feature));if(w.isValid()){setTimeout(function(){i.getSource().clear();window.clearInterval(e)},500);t.render();t.removeInteraction(n);n=null;s(v);$(".is-buffer-snap").hide()}else{j.getLayerByName("BUFFER_LAYER").getSource().clear();j.getLayerByName("BUFFER_LAYER").setVisible(false);n.clearOverlay_();setTimeout(function(){i.getSource().clear()},0);mini.alert("图形自相交，请重新绘制！","温馨提示")}});n.on("drawstart",function(u){if(!window.startTool){return}var v=u.feature.getGeometry().getFirstCoordinate();var w={X:v[0],Y:v[1],userId:userObj.userId};$.ajax({url:"pdsfcj.do",type:"post",data:{jsonStr:JSON.stringify(w)},dataType:"json",success:function(A){e=window.setInterval(d,1000*60*15);l=true;if(A.success){var x=A.code;var y=A.layerName;if(p(x,y)){l=false;f=false}else{f=true;j.getLayerByName("BUFFER_LAYER").getSource().clear();j.getLayerByName("BUFFER_LAYER").setVisible(false);if(n){n.finishDrawing();n.clearOverlay_()}window.clearInterval(e);var z=A.code+"_"+userObj.defineNd;mini.confirm("您未勾选"+(A.name?A.name:"")+"的数据！是否勾选？","温馨提示",function(C){if(C=="ok"){var B=b.getTree("zyjg").getNodes();var D=function(E){for(var G=0;G<E.length;G++){var H=E[G];var F=H.children||[];if(H.selectId==z){$("[tid="+H.id+"] a i").click()}if(F.length>0){D(F)}}};D(B)}else{$(".close-btn").length>0?$(".close-btn").click():""}})}}else{f=true;j.getLayerByName("BUFFER_LAYER").getSource().clear();j.getLayerByName("BUFFER_LAYER").setVisible(false);if(n){n.finishDrawing();n.clearOverlay_()}window.clearInterval(e);if(!A.name){mini.alert("获取当前位置错误！","错误提示");return}mini.confirm("您未创建"+(A.name?A.name:"")+"的数据！是否创建？","温馨提示",function(B){if(B=="ok"){require(["bhdk"],function(C){C.addBhdk(A.name,A.code,userObj.defineNd);c.loadTreeHasAdded();c.loadUserLayerManagePanel(userObj.zqCode,true)})}else{$(".close-btn").length>0?$(".close-btn").click():""}})}},error:function(x){h.validateSession(x);console.error(x)}})})}function p(s,t){var r=b.getTree("zyjg");var q=r.getCheckedNodes();for(var u=0;u<q.length;u++){var v=q[u];if(v._data&&v._data.xian&&v._data.xian==s){return 1}}return 0}function g(){var q=j.getMap().getInteractions().getArray();for(var r=0;r<q.length;r++){if(q[r] instanceof ol.interaction.Draw||q[r] instanceof ol.interaction.Select){n.clearOverlay_();j.getMap().removeInteraction(q[r]);n=null}}window.clearInterval(e);j.getLayerByName("BUFFER_LAYER").getSource().clear()}function k(){if(n&&n.a&&n.a&&n.a[0].length>1){n.removeLastPoint()}else{if(n&&n.sketchCoords_&&n.sketchCoords_&&n.sketchCoords_[0].length>1){n.removeLastPoint()}}}ol.interaction.Draw.handleEvent=function(t){this.freehand_=this.mode_!==ol.interaction.Draw.Mode_.POINT&&this.freehandCondition_(t);var s=!this.freehand_;if(this.freehand_&&t.type===ol.MapBrowserEventType.POINTERDRAG&&this.sketchFeature_!==null){if(!this.lastPixel){this.lastPixel=[0,0]}var r=t.pixel[0]-this.lastPixel[0];var q=t.pixel[1]-this.lastPixel[1];if(Math.sqrt(r*r+q*q)>10){this.addToDrawing_(t);this.lastPixel=t.pixel}s=false}else{if(t.type===ol.MapBrowserEventType.POINTERMOVE){s=this.handlePointerMove_(t)}else{if(t.type===ol.MapBrowserEventType.DBLCLICK){s=false}}}return ol.interaction.Pointer.handleEvent.call(this,t)&&s};function o(){return f}function d(){$.ajax({url:"updateSession.do",type:"GET",success:function(q){console.log(new Date())},error:function(q){h.validateSession(q)}})}return{draw:m,removeLastPoint:k,clear:g,getIsStop:o}});
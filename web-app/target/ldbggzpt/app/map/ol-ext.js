goog.require("ol");goog.require("ol.Collection");goog.require("ol.CollectionEventType");goog.require("ol.Feature");goog.require("ol.MapBrowserEventType");goog.require("ol.MapBrowserPointerEvent");goog.require("ol.array");goog.require("ol.coordinate");goog.require("ol.events");goog.require("ol.events.Event");goog.require("ol.events.EventType");goog.require("ol.events.condition");goog.require("ol.extent");goog.require("ol.geom.GeometryType");goog.require("ol.geom.Point");goog.require("ol.interaction.ModifyEventType");goog.require("ol.interaction.Pointer");goog.require("ol.layer.Vector");goog.require("ol.source.Vector");goog.require("ol.source.VectorEventType");goog.require("ol.structs.RBush");goog.require("ol.style.Style");ol.interaction.Modify=function(a){ol.interaction.Pointer.call(this,{handleDownEvent:ol.interaction.Modify.handleDownEvent_,handleDragEvent:ol.interaction.Modify.handleDragEvent_,handleEvent:ol.interaction.Modify.handleEvent,handleUpEvent:ol.interaction.Modify.handleUpEvent_});this.condition_=a.condition?a.condition:ol.events.condition.primaryAction;this.defaultDeleteCondition_=function(c){return ol.events.condition.altKeyOnly(c)&&ol.events.condition.singleClick(c)};this.deleteCondition_=a.deleteCondition?a.deleteCondition:this.defaultDeleteCondition_;this.insertVertexCondition_=a.insertVertexCondition?a.insertVertexCondition:ol.events.condition.always;this.vertexFeature_=null;this.vertexSegments_=null;this.lastPixel_=[0,0];this.ignoreNextSingleClick_=false;this.modified_=false;this.rBush_=new ol.structs.RBush();this.pixelTolerance_=a.pixelTolerance!==undefined?a.pixelTolerance:10;this.snappedToVertex_=false;this.changingFeature_=false;this.dragSegments_=[];this.overlay_=new ol.layer.Vector({source:new ol.source.Vector({useSpatialIndex:false,wrapX:!!a.wrapX}),style:a.style?a.style:ol.interaction.Modify.getDefaultStyleFunction(),updateWhileAnimating:true,updateWhileInteracting:true});this.SEGMENT_WRITERS_={Point:this.writePointGeometry_,LineString:this.writeLineStringGeometry_,LinearRing:this.writeLineStringGeometry_,Polygon:this.writePolygonGeometry_,MultiPoint:this.writeMultiPointGeometry_,MultiLineString:this.writeMultiLineStringGeometry_,MultiPolygon:this.writeMultiPolygonGeometry_,Circle:this.writeCircleGeometry_,GeometryCollection:this.writeGeometryCollectionGeometry_};this.source_=null;this.pointArr_=[];if(a.source){this.source_=a.source}this.showPoint_();var b;if(a.source){this.source_=a.source;b=new ol.Collection(this.source_.getFeatures());ol.events.listen(this.source_,ol.source.VectorEventType.ADDFEATURE,this.handleSourceAdd_,this);ol.events.listen(this.source_,ol.source.VectorEventType.REMOVEFEATURE,this.handleSourceRemove_,this)}else{b=a.features}if(!b){throw new Error("The modify interaction requires features or a source")}this.features_=b;this.features_.forEach(this.addFeature_,this);ol.events.listen(this.features_,ol.CollectionEventType.ADD,this.handleFeatureAdd_,this);ol.events.listen(this.features_,ol.CollectionEventType.REMOVE,this.handleFeatureRemove_,this);this.lastPointerEvent_=null};ol.inherits(ol.interaction.Modify,ol.interaction.Pointer);ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CENTER_INDEX=0;ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX=1;ol.interaction.Modify.prototype.showPoint_=function(){if(this.source_){for(var k=0;k<this.pointArr_.length;k++){this.source_.removeFeature(this.pointArr_[k])}var a=new ol.style.Style({image:new ol.style.Circle({radius:4,stroke:new ol.style.Stroke({color:"rgba(70,70,70,1)",width:1}),fill:new ol.style.Fill({color:"rgba(255,255,255,1)"})})});this.pointArr_=[];var c=this.source_.getFeatures();for(var e=0;e<c.length;e++){var l=c[e].getGeometry().getType();if(l=="Polygon"){var f=c[e].getGeometry().getCoordinates();for(var d=0;d<f.length;d++){var b=f[d];for(var k=0;k<b.length-1;k++){var n=new ol.Feature({geometry:new ol.geom.Point(b[k])});n.setStyle(a);this.pointArr_.push(n)}}}else{if(l=="MultiPolygon"){var f=c[e].getGeometry().getCoordinates();for(var d=0;d<f.length;d++){var h=f[d];for(var k=0;k<h.length;k++){var b=h[k];for(var m=0;m<b.length-1;m++){var n=new ol.Feature({geometry:new ol.geom.Point(b[m])});n.setStyle(a);this.pointArr_.push(n)}}}}}}this.source_.addFeatures(this.pointArr_);var g=new ol.Collection(this.pointArr_);g.forEach(this.addFeature_,this);ol.events.listen(g,ol.CollectionEventType.ADD,this.handleFeatureAdd_,this);ol.events.listen(g,ol.CollectionEventType.REMOVE,this.handleFeatureRemove_,this)}};ol.interaction.Modify.prototype.addFeature_=function(a){var c=a.getGeometry();if(c&&c.getType() in this.SEGMENT_WRITERS_){this.SEGMENT_WRITERS_[c.getType()].call(this,a,c)}var b=this.getMap();if(b&&b.isRendered()&&this.getActive()){this.handlePointerAtPixel_(this.lastPixel_,b)}ol.events.listen(a,ol.events.EventType.CHANGE,this.handleFeatureChange_,this)};ol.interaction.Modify.prototype.willModifyFeatures_=function(a){if(!this.modified_){this.modified_=true;this.dispatchEvent(new ol.interaction.Modify.Event(ol.interaction.ModifyEventType.MODIFYSTART,this.features_,a))}};ol.interaction.Modify.prototype.removeFeature_=function(a){this.removeFeatureSegmentData_(a);if(this.vertexFeature_&&this.features_.getLength()===0){this.overlay_.getSource().removeFeature(this.vertexFeature_);this.vertexFeature_=null}ol.events.unlisten(a,ol.events.EventType.CHANGE,this.handleFeatureChange_,this)};ol.interaction.Modify.prototype.removeFeatureSegmentData_=function(d){var b=this.rBush_;var a=[];b.forEach(function(e){if(d===e.feature){a.push(e)}});for(var c=a.length-1;c>=0;--c){b.remove(a[c])}};ol.interaction.Modify.prototype.setActive=function(a){if(this.vertexFeature_&&!a){this.overlay_.getSource().removeFeature(this.vertexFeature_);this.vertexFeature_=null}ol.interaction.Pointer.prototype.setActive.call(this,a)};ol.interaction.Modify.prototype.setMap=function(a){this.overlay_.setMap(a);ol.interaction.Pointer.prototype.setMap.call(this,a)};ol.interaction.Modify.prototype.handleSourceAdd_=function(c){if(c.feature){var a=this.features_.getArray();for(var b=0;b<a.length;b++){if(a[b].ol_uid==c.feature.ol_uid){return}}this.features_.push(c.feature)}};ol.interaction.Modify.prototype.handleSourceRemove_=function(a){if(a.feature){this.features_.remove(a.feature)}};ol.interaction.Modify.prototype.handleFeatureAdd_=function(a){this.addFeature_((a.element))};ol.interaction.Modify.prototype.handleFeatureChange_=function(a){if(!this.changingFeature_){var b=(a.target);this.removeFeature_(b);this.addFeature_(b)}};ol.interaction.Modify.prototype.handleFeatureRemove_=function(a){var b=(a.element);this.removeFeature_(b)};ol.interaction.Modify.prototype.writePointGeometry_=function(a,c){var b=c.getCoordinates();var d=({feature:a,geometry:c,segment:[b,b]});this.rBush_.insert(c.getExtent(),d)};ol.interaction.Modify.prototype.writeMultiPointGeometry_=function(b,f){var d=f.getCoordinates();var e,a,c,g;for(a=0,c=d.length;a<c;++a){e=d[a];g=({feature:b,geometry:f,depth:[a],index:a,segment:[e,e]});this.rBush_.insert(f.getExtent(),g)}};ol.interaction.Modify.prototype.writeLineStringGeometry_=function(b,f){var e=f.getCoordinates();var a,c,d,g;for(a=0,c=e.length-1;a<c;++a){d=e.slice(a,a+2);g=({feature:b,geometry:f,index:a,segment:d});this.rBush_.insert(ol.extent.boundingExtent(d),g)}};ol.interaction.Modify.prototype.writeMultiLineStringGeometry_=function(k,f){var l=f.getCoordinates();var g,b,h,a,d,c,e;for(a=0,d=l.length;a<d;++a){g=l[a];for(b=0,h=g.length-1;b<h;++b){c=g.slice(b,b+2);e=({feature:k,geometry:f,depth:[a],index:b,segment:c});this.rBush_.insert(ol.extent.boundingExtent(c),e)}}};ol.interaction.Modify.prototype.writePolygonGeometry_=function(l,f){var g=f.getCoordinates();var h,b,k,a,d,c,e;for(a=0,d=g.length;a<d;++a){h=g[a];for(b=0,k=h.length-1;b<k;++b){c=h.slice(b,b+2);e=({feature:l,geometry:f,depth:[a],index:b,segment:c});this.rBush_.insert(ol.extent.boundingExtent(c),e)}}};ol.interaction.Modify.prototype.writeMultiPolygonGeometry_=function(p,h){var m=h.getCoordinates();var n,d,o,c,f,b,a,l,e,g;for(b=0,a=m.length;b<a;++b){l=m[b];for(c=0,f=l.length;c<f;++c){n=l[c];for(d=0,o=n.length-1;d<o;++d){e=n.slice(d,d+2);g=({feature:p,geometry:h,depth:[c,b],index:d,segment:e});this.rBush_.insert(ol.extent.boundingExtent(e),g)}}}};ol.interaction.Modify.prototype.writeCircleGeometry_=function(c,f){var e=f.getCenter();var d=({feature:c,geometry:f,index:ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CENTER_INDEX,segment:[e,e]});var b=({feature:c,geometry:f,index:ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX,segment:[e,e]});var a=[d,b];d.featureSegments=b.featureSegments=a;this.rBush_.insert(ol.extent.createOrUpdateFromCoordinate(e),d);this.rBush_.insert(f.getExtent(),b)};ol.interaction.Modify.prototype.writeGeometryCollectionGeometry_=function(b,d){var a,c=d.getGeometriesArray();for(a=0;a<c.length;++a){this.SEGMENT_WRITERS_[c[a].getType()].call(this,b,c[a])}};ol.interaction.Modify.prototype.createOrUpdateVertexFeature_=function(c){var b=this.vertexFeature_;if(!b){b=new ol.Feature(new ol.geom.Point(c));this.vertexFeature_=b;this.overlay_.getSource().addFeature(b)}else{var a=(b.getGeometry());a.setCoordinates(c)}return b};ol.interaction.Modify.compareIndexes_=function(d,c){return d.index-c.index};ol.interaction.Modify.handleDownEvent_=function(q){if(!this.condition_(q)){return false}this.handlePointerAtPixel_(q.pixel,q.map);var n=q.map.getCoordinateFromPixel(q.pixel);this.dragSegments_.length=0;this.modified_=false;var a=this.vertexFeature_;if(a){var s=[];var o=(a.getGeometry());var k=o.getCoordinates();var b=ol.extent.boundingExtent([k]);var c=this.rBush_.getInExtent(b);var p={};c.sort(ol.interaction.Modify.compareIndexes_);for(var g=0,r=c.length;g<r;++g){var m=c[g];var h=m.segment;var l=ol.getUid(m.feature);var f=m.depth;if(f){l+="-"+f.join("-")}if(!p[l]){p[l]=new Array(2)}if(m.geometry.getType()===ol.geom.GeometryType.CIRCLE&&m.index===ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX){var e=ol.interaction.Modify.closestOnSegmentData_(n,m);if(ol.coordinate.equals(e,k)&&!p[l][0]){this.dragSegments_.push([m,0]);p[l][0]=m}}else{if(ol.coordinate.equals(h[0],k)&&!p[l][0]){this.dragSegments_.push([m,0]);p[l][0]=m}else{if(ol.coordinate.equals(h[1],k)&&!p[l][1]){if((m.geometry.getType()===ol.geom.GeometryType.LINE_STRING||m.geometry.getType()===ol.geom.GeometryType.MULTI_LINE_STRING)&&p[l][0]&&p[l][0].index===0){continue}this.dragSegments_.push([m,1]);p[l][1]=m}else{if(this.insertVertexCondition_(q)&&ol.getUid(h) in this.vertexSegments_&&(!p[l][0]&&!p[l][1])){s.push([m,k])}}}}}if(s.length){this.willModifyFeatures_(q)}for(var d=s.length-1;d>=0;--d){this.insertVertex_.apply(this,s[d])}}return !!this.vertexFeature_};ol.interaction.Modify.handleDragEvent_=function(k){this.ignoreNextSingleClick_=false;this.willModifyFeatures_(k);var e=k.coordinate;for(var c=0,l=this.dragSegments_.length;c<l;++c){var a=this.dragSegments_[c];var g=a[0];var b=g.depth;var h=g.geometry;var j;var d=g.segment;var f=a[1];while(e.length<h.getStride()){e.push(d[f][e.length])}switch(h.getType()){case ol.geom.GeometryType.POINT:j=e;d[0]=d[1]=e;break;case ol.geom.GeometryType.MULTI_POINT:j=h.getCoordinates();j[g.index]=e;d[0]=d[1]=e;break;case ol.geom.GeometryType.LINE_STRING:j=h.getCoordinates();j[g.index+f]=e;d[f]=e;break;case ol.geom.GeometryType.MULTI_LINE_STRING:j=h.getCoordinates();j[b[0]][g.index+f]=e;d[f]=e;break;case ol.geom.GeometryType.POLYGON:j=h.getCoordinates();j[b[0]][g.index+f]=e;d[f]=e;break;case ol.geom.GeometryType.MULTI_POLYGON:j=h.getCoordinates();j[b[1]][b[0]][g.index+f]=e;d[f]=e;break;case ol.geom.GeometryType.CIRCLE:d[0]=d[1]=e;if(g.index===ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CENTER_INDEX){this.changingFeature_=true;h.setCenter(e);this.changingFeature_=false}else{this.changingFeature_=true;h.setRadius(ol.coordinate.distance(h.getCenter(),e));this.changingFeature_=false}break;default:}if(j){this.setGeometryCoordinates_(h,j)}}this.createOrUpdateVertexFeature_(e)};ol.interaction.Modify.handleUpEvent_=function(a){var g;var f;for(var c=this.dragSegments_.length-1;c>=0;--c){g=this.dragSegments_[c][0];f=g.geometry;if(f.getType()===ol.geom.GeometryType.CIRCLE){var e=f.getCenter();var d=g.featureSegments[0];var b=g.featureSegments[1];d.segment[0]=d.segment[1]=e;b.segment[0]=b.segment[1]=e;this.rBush_.update(ol.extent.createOrUpdateFromCoordinate(e),d);this.rBush_.update(f.getExtent(),b)}else{this.rBush_.update(ol.extent.boundingExtent(g.segment),g)}}this.showPoint_();if(this.modified_){this.dispatchEvent(new ol.interaction.Modify.Event(ol.interaction.ModifyEventType.MODIFYEND,this.features_,a));this.modified_=false}return false};ol.interaction.Modify.handleEvent=function(b){if(!(b instanceof ol.MapBrowserPointerEvent)){return true}this.lastPointerEvent_=b;var a;if(!b.map.getView().getInteracting()&&b.type==ol.MapBrowserEventType.POINTERMOVE&&!this.handlingDownUpSequence){this.handlePointerMove_(b)}if(this.vertexFeature_&&this.deleteCondition_(b)){if(b.type!=ol.MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_){a=this.removePoint()}else{a=true}}if(b.type==ol.MapBrowserEventType.SINGLECLICK){this.ignoreNextSingleClick_=false}return ol.interaction.Pointer.handleEvent.call(this,b)&&!a};ol.interaction.Modify.prototype.handlePointerMove_=function(a){this.lastPixel_=a.pixel;this.handlePointerAtPixel_(a.pixel,a.map)};ol.interaction.Modify.prototype.handlePointerAtPixel_=function(e,s){var r=s.getCoordinateFromPixel(e);var c=function(v,i){return ol.interaction.Modify.pointDistanceToSegmentDataSquared_(r,v)-ol.interaction.Modify.pointDistanceToSegmentDataSquared_(r,i)};var g=ol.extent.buffer(ol.extent.createOrUpdateFromCoordinate(r),s.getView().getResolution()*this.pixelTolerance_);var q=this.rBush_;var l=q.getInExtent(g);if(l.length>0){l.sort(c);var n=l[0];var b=n.segment;var p=ol.interaction.Modify.closestOnSegmentData_(r,n);var f=s.getPixelFromCoordinate(p);var j=ol.coordinate.distance(e,f);if(j<=this.pixelTolerance_){var d={};if(n.geometry.getType()===ol.geom.GeometryType.CIRCLE&&n.index===ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX){this.snappedToVertex_=true;this.createOrUpdateVertexFeature_(p)}else{var u=s.getPixelFromCoordinate(b[0]);var t=s.getPixelFromCoordinate(b[1]);var m=ol.coordinate.squaredDistance(f,u);var k=ol.coordinate.squaredDistance(f,t);j=Math.sqrt(Math.min(m,k));this.snappedToVertex_=j<=this.pixelTolerance_;if(this.snappedToVertex_){p=m>k?b[1]:b[0]}this.createOrUpdateVertexFeature_(p);var a;for(var o=1,h=l.length;o<h;++o){a=l[o].segment;if((ol.coordinate.equals(b[0],a[0])&&ol.coordinate.equals(b[1],a[1])||(ol.coordinate.equals(b[0],a[1])&&ol.coordinate.equals(b[1],a[0])))){d[ol.getUid(a)]=true}else{break}}}d[ol.getUid(b)]=true;this.vertexSegments_=d;return}}if(this.vertexFeature_){this.overlay_.getSource().removeFeature(this.vertexFeature_);this.vertexFeature_=null}};ol.interaction.Modify.pointDistanceToSegmentDataSquared_=function(a,f){var d=f.geometry;if(d.getType()===ol.geom.GeometryType.CIRCLE){var b=(d);if(f.index===ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX){var e=ol.coordinate.squaredDistance(b.getCenter(),a);var c=Math.sqrt(e)-b.getRadius();return c*c}}return ol.coordinate.squaredDistanceToSegment(a,f.segment)};ol.interaction.Modify.closestOnSegmentData_=function(a,c){var b=c.geometry;if(b.getType()===ol.geom.GeometryType.CIRCLE&&c.index===ol.interaction.Modify.MODIFY_SEGMENT_CIRCLE_CIRCUMFERENCE_INDEX){return b.getClosestPoint(a)}return ol.coordinate.closestOnSegment(a,c.segment)};ol.interaction.Modify.prototype.insertVertex_=function(h,e){var f=h.segment;var k=h.feature;var i=h.geometry;var c=h.depth;var g=(h.index);var j;while(e.length<i.getStride()){e.push(0)}switch(i.getType()){case ol.geom.GeometryType.MULTI_LINE_STRING:j=i.getCoordinates();j[c[0]].splice(g+1,0,e);break;case ol.geom.GeometryType.POLYGON:j=i.getCoordinates();j[c[0]].splice(g+1,0,e);break;case ol.geom.GeometryType.MULTI_POLYGON:j=i.getCoordinates();j[c[1]][c[0]].splice(g+1,0,e);break;case ol.geom.GeometryType.LINE_STRING:j=i.getCoordinates();j.splice(g+1,0,e);break;default:return}this.setGeometryCoordinates_(i,j);var b=this.rBush_;b.remove(h);this.updateSegmentIndices_(i,g,c,1);var a=({segment:[f[0],e],feature:k,geometry:i,depth:c,index:g});b.insert(ol.extent.boundingExtent(a.segment),a);this.dragSegments_.push([a,1]);var d=({segment:[e,f[1]],feature:k,geometry:i,depth:c,index:g+1});b.insert(ol.extent.boundingExtent(d.segment),d);this.dragSegments_.push([d,0]);this.ignoreNextSingleClick_=true};ol.interaction.Modify.prototype.removePoint=function(){if(this.lastPointerEvent_&&this.lastPointerEvent_.type!=ol.MapBrowserEventType.POINTERDRAG){var a=this.lastPointerEvent_;this.willModifyFeatures_(a);this.removeVertex_();this.dispatchEvent(new ol.interaction.Modify.Event(ol.interaction.ModifyEventType.MODIFYEND,this.features_,a));this.modified_=false;return true}return false};ol.interaction.Modify.prototype.removeVertex_=function(){var d=this.dragSegments_;var l={};var a=false;var n,o,e,m,f,j,b;var q,p,k,h;for(f=d.length-1;f>=0;--f){e=d[f];k=e[0];h=ol.getUid(k.feature);if(k.depth){h+="-"+k.depth.join("-")}if(!(h in l)){l[h]={}}if(e[1]===0){l[h].right=k;l[h].index=k.index}else{if(e[1]==1){l[h].left=k;l[h].index=k.index+1}}}for(h in l){p=l[h].right;b=l[h].left;j=l[h].index;q=j-1;if(b!==undefined){k=b}else{k=p}if(q<0){q=0}m=k.geometry;o=m.getCoordinates();n=o;a=false;switch(m.getType()){case ol.geom.GeometryType.MULTI_LINE_STRING:if(o[k.depth[0]].length>2){o[k.depth[0]].splice(j,1);a=true}break;case ol.geom.GeometryType.LINE_STRING:if(o.length>2){o.splice(j,1);a=true}break;case ol.geom.GeometryType.MULTI_POLYGON:n=n[k.depth[1]];case ol.geom.GeometryType.POLYGON:n=n[k.depth[0]];if(n.length>4){if(j==n.length-1){j=0}n.splice(j,1);a=true;if(j===0){n.pop();n.push(n[0]);q=n.length-1}}break;default:}if(a){this.setGeometryCoordinates_(m,o);var g=[];if(b!==undefined){this.rBush_.remove(b);g.push(b.segment[0])}if(p!==undefined){this.rBush_.remove(p);g.push(p.segment[1])}if(b!==undefined&&p!==undefined){var c=({depth:k.depth,feature:k.feature,geometry:k.geometry,index:q,segment:g});this.rBush_.insert(ol.extent.boundingExtent(c.segment),c)}this.updateSegmentIndices_(m,j,k.depth,-1);if(this.vertexFeature_){this.overlay_.getSource().removeFeature(this.vertexFeature_);this.vertexFeature_=null}d.length=0}}return a};ol.interaction.Modify.prototype.setGeometryCoordinates_=function(b,a){this.changingFeature_=true;b.setCoordinates(a);this.changingFeature_=false};ol.interaction.Modify.prototype.updateSegmentIndices_=function(c,a,b,d){this.rBush_.forEachInExtent(c.getExtent(),function(e){if(e.geometry===c&&(b===undefined||e.depth===undefined||ol.array.equals(e.depth,b))&&e.index>a){e.index+=d}})};ol.interaction.Modify.getDefaultStyleFunction=function(){var a=ol.style.Style.createDefaultEditing();return function(c,b){return a[ol.geom.GeometryType.POINT]}};ol.interaction.Modify.Event=function(b,a,c){ol.events.Event.call(this,b);this.features=a;this.mapBrowserEvent=c};ol.inherits(ol.interaction.Modify.Event,ol.events.Event);
define([
    'map',
    'config'
], function(map, config) {
    'use strict';
    var defaultStyle = new ol.style.Style({
        fill: new ol.style.Fill({ color: "rgba(255,255,255,0)" }),
        stroke: new ol.style.Stroke({ color: 'rgb(255,255,0)', width: 3 })
    });
    /**
     * @param {any} type
     * @param {any} coor
     * @param {any} tableName
     * @param {any} propertyName
     * @param {any} callback
     */
   
    /**
     * 针对geoServer进行查询（包括属性，空间) wfs方式
     * @param {object} options 
     * @param {function} callBack 
     */
    function query(options) {
        $.ajax(config.PROXY + '?' + options.url + '?', {
            type: 'GET',
            data: {
                service: 'WFS',
                version: '1.0.0',
                request: 'GetFeature',
                typename: options.typename, //服务名称
                outputFormat: 'application/json', //返回格式
                maxFeatures: 5000, //最大返回值
                filter: getFilter(options) //查询条件  可以传点、线、面、属性
            },
            success: options.success,
            error: function(err) {
                console.error("查询geoserver wfs 错误" + err);
            }
        });
    };
    /**
     * 拼接geoserver查询格式
     * */
    function getFilter(options) {
        var op = options.XY.toString();
        var geo = "the_geom";
        var filter = '<Filter xmlns="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml"><Intersects>  <PropertyName>' +
            geo + '</PropertyName>  <gml:Point>  <gml:coordinates>' +
            op + '</gml:coordinates>  </gml:Point>  </Intersects> </Filter>'
        return filter;
    };
    /**
     *空间查询
     *@parma option{coor,layerName,nd}
     *@callback function
     * */
    function queryBySpace(coor,nd,option,callback) {
    	if(option.url){
    		var datas = {
                    lng:coor[0],
                    lat:coor[1],
                    years:nd
               }
    		$.ajax({
                url:option.url,
                type:"GET",
                data:datas,
                success:function(res){
                    if(callback){
                        callback(res);
                    }
                },
                error:function(err){
                    console.error("调用易伟航接口错误："+err);
                }
            });
    	}else{
    		if(option.queryType=="bhdk"){
    			var data = {X:coor[0],Y:coor[1],nd:'2009',queryType:"BHDK"};
    			//callback({type:"bhdk","success":true,"data":'{"C_XIAN":"360323","C_HSBHYY":null,"L_LON_DEG":null,"D_CREATETIME":null,"C_CUN":"360323008010","D_EDITTIME":null,"C_YSBHYY":null,"I_EDITUSERID":null,"C_YIJU":null,"L_LAT_DEG":null,"C_NR":null,"C_XIANG":"360323008","C_XIAOBAN":"0037","ID":1278099,"D_AREA":2.806E-5,"I_CREATEUSERID":" ","OBJECTID":1}'});
    		}else{
    			var data = {X:coor[0],Y:coor[1],nd:'2009',queryType:option.queryType,layerId:option.layerId};
    			callback({type:"ywsj","success":true,
    				"data":'{"C_XIAN":"360323","C_HSBHYY":null,"L_LON_DEG":null,"D_CREATETIME":null,"C_CUN":"360323008010","D_EDITTIME":null,"C_YSBHYY":null,"I_EDITUSERID":null,"C_YIJU":null,"L_LAT_DEG":null,"C_NR":null,"C_XIANG":"360323008","C_XIAOBAN":"0037","ID":1278099,"D_AREA":3,"I_CREATEUSERID":" ","OBJECTID":1,"WKT":"POLYGON  (( 113.99345941 27.43668190, 113.99337716 27.43670990, 113.99325751 27.43673721, 113.99314070 27.43677077, 113.99302671 27.43681057, 113.99264176 27.43697570, 113.99234918 27.43708565, 113.99227428 27.43712045, 113.99219047 27.43716971, 113.99185956 27.43741659, 113.99150644 27.43766417, 113.99117405 27.43791329, 113.99090668 27.43810307, 113.99080656 27.43818178, 113.99067995 27.43830608, 113.99051788 27.43851132, 113.99044907 27.43859094, 113.99026118 27.43877064, 113.99020338 27.43883341, 113.99013693 27.43892506, 113.99001299 27.43913083, 113.98981737 27.43943137, 113.98954655 27.43990173, 113.98948961 27.43999179, 113.98933722 27.43992877, 113.98918283 27.43988097, 113.98902518 27.43984694, 113.98880732 27.43981816, 113.98798587 27.43976666, 113.98769096 27.43975850, 113.98722976 27.43975791, 113.98710975 27.43974798, 113.98702703 27.43972211, 113.98695374 27.43968277, 113.98687560 27.43964083, 113.98681749 27.43962080, 113.98675094 27.43960958, 113.98654479 27.43959191, 113.98648054 27.43957805, 113.98638792 27.43954724, 113.98629765 27.43950432, 113.98620781 27.43944881, 113.98612385 27.43938689, 113.98593621 27.43923438, 113.98581005 27.43914948, 113.98575315 27.43912242, 113.98571398 27.43911250, 113.98567447 27.43911275, 113.98562865 27.43912897, 113.98559012 27.43915877, 113.98557195 27.43918351, 113.98555936 27.43922343, 113.98556083 27.43926594, 113.98559027 27.43935174, 113.98567586 27.43950503, 113.98571339 27.43958925, 113.98573316 27.43965975, 113.98580150 27.43997973, 113.98581360 27.44006182, 113.98581554 27.44013504, 113.98580554 27.44024525, 113.98578698 27.44034033, 113.98576628 27.44040573, 113.98574064 27.44045040, 113.98560484 27.44072260, 113.98550989 27.44075238, 113.98549279 27.44076215, 113.98527354 27.44088732, 113.98522149 27.44106863, 113.98510800 27.44124573, 113.98500872 27.44135536, 113.98490944 27.44141440, 113.98474417 27.44143367, 113.98453147 27.44128174, 113.98443734 27.44122861, 113.98438142 27.44120417, 113.98415647 27.44112400, 113.98393190 27.44100258, 113.98373943 27.44092072, 113.98367357 27.44087383, 113.98358606 27.44077485, 113.98354733 27.44074015, 113.98352035 27.44072316, 113.98345985 27.44069710, 113.98332857 27.44065641, 113.98327420 27.44063416, 113.98307118 27.44050999, 113.98298221 27.44046514, 113.98288788 27.44043220, 113.98279086 27.44041745, 113.98272321 27.44042306, 113.98268374 27.44038586, 113.98231372 27.44031526, 113.98230497 27.44030714, 113.98224532 27.44026953, 113.98218157 27.44023960, 113.98208140 27.44020365, 113.98194647 27.44016328, 113.98189194 27.44014979, 113.98180908 27.44012931, 113.98164163 27.44009657, 113.98136242 27.43995962, 113.98134270 27.43994125, 113.98128953 27.43986805, 113.98127070 27.43982887, 113.98106343 27.43972208, 113.98100618 27.43967789, 113.98097560 27.43961721, 113.98098250 27.43958403, 113.98098851 27.43954984, 113.98101966 27.43950389, 113.98104243 27.43947290, 113.98110832 27.43944512, 113.98119456 27.43940023, 113.98137519 27.43936450, 113.98160995 27.43939607, 113.98164489 27.43943973, 113.98169519 27.43948140, 113.98178740 27.43948460, 113.98191078 27.43947924, 113.98195749 27.43944825, 113.98200905 27.43928690, 113.98200906 27.43926446, 113.98201147 27.43922493, 113.98200553 27.43906572, 113.98199356 27.43904115, 113.98197683 27.43896742, 113.98197685 27.43890224, 113.98197688 27.43881997, 113.98195772 27.43878364, 113.98192300 27.43877509, 113.98187627 27.43879433, 113.98178514 27.43888786, 113.98176728 27.43893334, 113.98173426 27.43899037, 113.98168812 27.43903153, 113.98162826 27.43905721, 113.98155520 27.43906042, 113.98150849 27.43904974, 113.98148575 27.43900914, 113.98147512 27.43897948, 113.98148362 27.43891091, 113.98151815 27.43882001, 113.98152415 27.43878047, 113.98151459 27.43872170, 113.98146731 27.43862587, 113.98145716 27.43856251, 113.98145721 27.43840223, 113.98149192 27.43830390, 113.98151115 27.43828255, 113.98160731 27.43817653, 113.98163530 27.43816821, 113.98181014 27.43821036, 113.98198340 27.43823283, 113.98245954 27.43815237, 113.98247285 27.43814413, 113.98269207 27.43802786, 113.98276588 27.43797166, 113.98283436 27.43789039, 113.98293423 27.43773870, 113.98297543 27.43768555, 113.98306879 27.43758824, 113.98317436 27.43750078, 113.98328921 27.43742056, 113.98344533 27.43732467, 113.98364571 27.43722050, 113.98374954 27.43717658, 113.98385548 27.43713984, 113.98396332 27.43711155, 113.98407286 27.43709299, 113.98418387 27.43708547, 113.98440638 27.43708996, 113.98475153 27.43707677, 113.98490509 27.43707915, 113.98546689 27.43711917, 113.98607531 27.43714219, 113.98651044 27.43716766, 113.98667674 27.43717172, 113.98688323 27.43716166, 113.98728422 27.43710501, 113.98747670 27.43708935, 113.98759731 27.43709066, 113.98788705 27.43710456, 113.98806373 27.43710589, 113.98877652 27.43708168, 113.98898139 27.43707949, 113.98928287 27.43708535, 113.98945449 27.43707391, 113.98956528 27.43705048, 113.98977426 27.43698682, 113.99010133 27.43690688, 113.99024121 27.43686453, 113.99037100 27.43680544, 113.99056244 27.43669420, 113.99066250 27.43665216, 113.99073031 27.43663700, 113.99108421 27.43656686, 113.99123932 27.43654973, 113.99135550 27.43657304, 113.99142807 27.43657605, 113.99150170 27.43657261, 113.99187679 27.43652035, 113.99199086 27.43651327, 113.99272558 27.43651469, 113.99285436 27.43652705, 113.99293051 27.43654089, 113.99308076 27.43657957, 113.99330581 27.43664628, 113.99345941 27.43668190))"}'});
    			return;
    		}
    		$.ajax({
    			url:"spaceQuery.do",
    			type:"POST",
    			data:{jsonStr:JSON.stringify(data)},
    			success:function(res){
    				 if(callback){
                         callback(res);
                     }
    			},
    			error:function(err){
    				
    				//console.error("查询服务错误："+err);
    			}
    		});
    	}
    	
    	
    }
    /*
     * 获取政区名称方法（调用天地图接口）
     * center 点坐标数组
     * callback  回调函数
     * */
    function queryZqNameByPoint(center,callback) {
            var coorJson="{'lon':"+center[0]+",'lat':"+center[1]+",'appkey':"+config.appKey+",'ver':1}";
            $.ajax({
                url:config.queryZqUrl+"?",
//                url:config.PROXY+"?"+config.queryZqUrl+"?",
                type:"GET",
                data:{
                    postStr:coorJson,
                    type:'geocode'
                },
                success:function(res){
                    if(callback){
                        callback(res);
                    }
                },
                error:function(err){
                    console.error("调用地址逆编码错误："+err);
                }
            });
    }
    //范围查询小班
    function queryByExtent(url,layerObj){
    	var geojsonFormat = new ol.format.GeoJSON();
    	var xian = url.split("/")[(url.split("/").length-1)]
    	var layer = layerObj[xian];
		  $.ajax({
			  url:config.PROXY+"?"+url,//"http://192.168.1.234:9010/web-ws/ws/rest/DS/export/zyjg/114.02255058289/27.5941747427/114.03551101685/27.604131102563/360323",
			  type:"GET",
			  success:function(res){
				  if(res){
					  var obj = JSON.parse(res);
					  var data = obj.data;
					  for(var i=0;i<data.length;i++){
						  var geojson={
		                    type:'Feature',
		                    geometry:JSON.parse(data[i].shape),
		                    properties:{ID:data[i].objectid}
						  }
						  var feature = geojsonFormat.readFeature(geojson);
						  feature.setStyle(defaultStyle);
						  layer.getSource().addFeature(feature);
					  }
				  }else{
					  if(layerObj[xian]){
						  layerObj[xian].setVisible(false);
						  map.getMap().removeLayer(layerObj[xian]);
						  delete layerObj[xian];
					  }
				  }
			  }
		  });
	  }
    return {
        query:query,
        queryBySpace:queryBySpace,
        queryZqNameByPoint:queryZqNameByPoint,
        queryByExtent:queryByExtent
    }
});